<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duties Calendar</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

    <style>
        /* --- Root Variables and Body --- */
        :root {
            --primary-color: #007bff;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --border-color: #dee2e6;
            --text-color: #343a40;
            --white: #ffffff;
            --danger-color: #ff4444;
        }
        html, body {
            overflow: hidden;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            color: var(--text-color);
            background-color: var(--light-gray);
        }

        /* --- Main Layout --- */
        .calendar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .swiper-container {
            flex-grow: 1;
            min-height: 0;
            position: relative;
        }
        .swiper {
            height: 100%;
        }
        .calendar-wrapper {
            overflow-y: auto;
            overflow-x: hidden;
            height: 100%;
        }
        
        /* --- View Toggle Styles --- */
        .table-view {
            display: none;
            height: 100%;
        }
        .table-view.active {
            display: block;
        }

        /* --- Header & Toolbar (Ultra-Compacted) --- */
        .calendar-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--light-gray);
            border-bottom: 1px solid var(--border-color);
            transform: translateY(0);
            transition: transform 0.3s ease-in-out;
            margin: -1rem -1rem 0.5rem -1rem; /* Reduced bottom margin */
            padding: 1rem;
        }
        .calendar-header.hidden {
            transform: translateY(-100%);
        }
        
        /* New container for the main nav controls */
        .navigation-controls {
            display: flex;
            justify-content: center; /* Center the entire block */
            align-items: center;
            gap: 0.5rem; /* Gap between arrows and buttons */
            margin-bottom: 0.25rem; /* Reduced margin */
        }
        .swiper-button-next, .swiper-button-prev {
            position: static !important;
            margin: 0 !important;
            width: auto;
            height: auto;
            color: var(--primary-color);
        }
        .swiper-button-prev:after, .swiper-button-next:after {
            font-size: 1.25rem;
            font-weight: bold;
        }

        /* --- Filter Controls (Compacted) --- */
        .calendar-toolbar {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem; /* Reduced margin */
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-container {
            display: flex;
            justify-content: center;
            position: relative;
        }
        .view-toggle-container {
            display: flex;
            justify-content: center;
            position: relative;
        }
        .control-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            background-color: var(--white);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .control-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .control-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .control-btn.view-toggle:hover {
            background-color: var(--medium-gray);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .view-icon {
            margin-right: 0.5rem;
        }
        #filter-trigger-btn:after {
            content: 'â–¼';
            font-size: 0.7em;
            margin-left: 5px;
        }
        .filter-dropdown-panel {
            display: none;
            position: fixed;
            background-color: var(--white);
            min-width: 300px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            z-index: 1001;
            padding: 1rem;
            left: 50%;
            top: 20%;
            transform: translateX(-50%);
        }
        .filter-dropdown-panel.active {
            display: block;
        }
        .role-filters-expanded {
            display: none; /* Always hidden now */
        }
        .filter-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            justify-content: center;
        }
        .filter-control-btn {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            background: var(--white);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .filter-control-btn:hover {
            background: var(--light-gray);
        }
        .filter-options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: flex-start;
        }
        .role-option {
            display: block;
            width: calc(50% - 0.25rem);
            margin-bottom: 0.25rem;
        }
        .role-option input[type="checkbox"] { display: none; }
        .role-option label {
            display: block;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            background: #f1f3f5;
            color: #343a40;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            border: 1px solid var(--border-color);
            user-select: none;
            text-align: center;
            font-size: 0.875rem;
            width: 100%;
            box-sizing: border-box;
        }
        .role-option input[type="checkbox"]:checked + label {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        /* --- Quick Day Navigation (Compacted) --- */
        .quick-nav {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
            margin: 0;
            flex-grow: 1; /* Allow the nav to fill space between arrows */
        }
        .quick-nav-btn {
            flex-grow: 1;
            flex-basis: 0;
            padding: 0.5rem 0.25rem;
            border: 1px solid var(--border-color);
            background: var(--white);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            text-align: center;
            white-space: nowrap;
        }
        .quick-nav-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .quick-nav-btn.active {
            background: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
        }

        /* --- Color Key (Compacted) --- */
        .color-key-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.25rem 1rem;
            margin: 0; /* Remove margin since it's now inline */
        }
        .key-item {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            color: #555;
        }
        .key-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 6px;
            display: inline-block;
            flex-shrink: 0;
        }

        /* --- Card View Layout --- */
        .card-view {
            display: none;
            padding: 0.5rem;
            gap: 1rem;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }
        .card-view.active {
            display: flex;
        }
        .agenda-card {
            background: var(--white);
            border: 2px solid #6385ff;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .agenda-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--text-color);
            margin: 0;
        }
        .card-time {
            font-size: 0.9rem;
            color: #666;
            background: var(--light-gray);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            white-space: nowrap;
            font-weight: 500;
        }
        .card-description {
            color: #555;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        .card-roles {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .role-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        .role-assignment {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: 0.375rem;
            border-left: 4px solid var(--primary-color);
        }
        .role-name {
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }
        .role-activity {
            color: #555;
            font-size: 0.9rem;
        }
        .no-events-card {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
        }
        .role-pair-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, var(--border-color), transparent);
            margin: 0.25rem 0;
            position: relative;
        }
        .role-pair-divider::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background: var(--border-color);
            border-radius: 50%;
        }

        /* --- Calendar Grid & Events --- */
        .calendar {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            max-width: 100%;
        }
        .calendar th {
            position: sticky;
            top: 0;
            z-index: 3;
            background-color: var(--medium-gray);
            padding: 0.75rem 0.5rem;
            font-weight: bold;
            border-bottom: 2px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .calendar th, .calendar td {
            border: 1px solid var(--border-color);
            padding: 0;
            text-align: center;
            vertical-align: top;
            word-break: break-word;
        }
        .calendar td.role-col {
            height: 40px;
            vertical-align: stretch;
        }
        .calendar th.time-col, .calendar td.time-col {
            position: sticky;
            left: 0;
            background: #f1f3f5;
            z-index: 2;
            padding: 0.75rem;
            font-weight: bold;
            width: 60px;
        }
        .calendar th.time-col {
            z-index: 4; /* Higher z-index for the top-left corner cell */
        }
        
        /* Mobile abbreviation styles */
        .calendar th.role-col .full-text {
            display: inline;
        }
        .calendar th.role-col .mobile-abbr {
            display: none;
        }
        
        /* Show abbreviations on mobile when there are many columns */
        @media (max-width: 768px) {
            .calendar.many-columns th.role-col .full-text {
                display: none;
            }
            .calendar.many-columns th.role-col .mobile-abbr {
                display: inline;
            }
        }

        /* Event text display control */
        .event-abbr-only {
            display: none;
        }
        
        /* When there are many columns, show only abbreviations for events */
        .calendar.many-columns .event-full {
            display: none;
        }
        .calendar.many-columns .event-abbr-only {
            display: inline;
        }
        
        .event {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            text-align: left;
            display: flex;
            align-items: flex-start;
            box-sizing: border-box;
            padding: 0.5rem;
            white-space: normal;
            min-height: 100%;
        }
        .event > div:first-child {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            top: 48px; /* Position sticky text just below the calendar header */
        }
        .event-type-free { background-color: #f8f9fa; border-left: 3px solid #6c757d; }
        .event-type-break { background-color: #fff3cd; border-left: 3px solid #ffc107; }
        .event-type-meeting { background-color: #cff4fc; border-left: 3px solid #0dcaf0; }
        .event-type-duty { background-color: #d1e7dd; border-left: 3px solid #198754; }
        .event-type-agenda { background-color: #dbe4ff; border-left: 3px solid #6385ff; }

        /* --- Quality of Life (QOL) Components --- */
        .tooltip {
            position: relative;
            cursor: pointer;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.4;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .current-time-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--danger-color);
            z-index: 10;
            box-shadow: 0 0 5px rgba(255, 68, 68, 0.5);
            pointer-events: none;
        }
        .current-time-indicator::before {
            content: '';
            position: absolute;
            left: -5px;
            top: -4px;
            width: 10px;
            height: 10px;
            background: var(--danger-color);
            border-radius: 50%;
        }
        
        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .time-col, .calendar th.time-col, .calendar td.time-col {
                width: 45px !important;
                font-size: 0.7rem;
                padding: 0.25rem !important;
            }
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .card-title {
                font-size: 1.1rem;
            }
        }
        @media (max-width: 480px) {
            .calendar-toolbar {
                gap: 0.5rem; /* Reduced gap on mobile */
            }
            .color-key-container {
                gap: 0.15rem 0.5rem; /* Reduced spacing on mobile */
            }
            .key-item {
                font-size: 0.65rem; /* Smaller font size on mobile */
            }
            .agenda-card {
                padding: 1rem;
            }
            .card-title {
                font-size: 1rem;
            }
        }

        /* --- Print Styles --- */
        @media print {
            body { overflow: visible !important; height: auto; }
            .calendar-header { display: none !important; }
            .calendar-container { position: static !important; height: auto !important; overflow: visible !important; }
            .swiper-container, .swiper { height: auto !important; overflow: visible; }
            .swiper-wrapper { display: block !important; }
            .swiper-slide { display: block !important; page-break-inside: avoid; margin-bottom: 2rem; }
            .event > div:first-child { position: static; }
        }
    </style>
</head>
<body>
    <div id="calendar-container" class="calendar-container">
        <header class="calendar-header" id="calendar-header">
            <section class="calendar-toolbar">
                <div class="filter-container">
                    <button id="filter-trigger-btn" class="control-btn">Filter Roles</button>
                    <div id="filter-panel" class="filter-dropdown-panel">
                        </div>
                </div>
                <div class="view-toggle-container">
                    <button id="view-toggle-btn" class="control-btn view-toggle">
                        Table View
                    </button>
                </div>
                <section class="color-key-container">
                    <div class="key-item"><span class="key-color" style="background-color: #dbe4ff;"></span>Main Agenda</div>
                    <div class="key-item"><span class="key-color" style="background-color: #d1e7dd;"></span>Duty</div>
                    <div class="key-item"><span class="key-color" style="background-color: #cff4fc;"></span>Meeting</div>
                    <div class="key-item"><span class="key-color" style="background-color: #fff3cd;"></span>Break/Off</div>
                    <div class="key-item"><span class="key-color" style="background-color: #f8f9fa; border: 1px solid #dee2e6;"></span>Free</div>
                </section>
            </section>

            <section class="role-filters-expanded" id="role-filters-expanded" style="display: none;">
                <!-- This section is now permanently hidden -->
            </section>

            <nav class="navigation-controls">
                <button class="swiper-button-prev"></button>
                <div class="quick-nav" id="quick-nav">
                    <button class="quick-nav-btn" data-day="Sunday">Sun</button>
                    <button class="quick-nav-btn" data-day="Monday">Mon</button>
                    <button class="quick-nav-btn" data-day="Tuesday">Tue</button>
                    <button class="quick-nav-btn" data-day="Wednesday">Wed</button>
                    <button class="quick-nav-btn" data-day="Thursday">Thu</button>
                    <button class="quick-nav-btn" data-day="Friday">Fri</button>
                    <button class="quick-nav-btn" data-day="Saturday">Sat</button>
                </div>
                <button class="swiper-button-next"></button>
            </nav>
        </header>

        <main class="swiper-container">
            <div class="swiper">
                <div class="swiper-wrapper">
                    </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
   
    <script>
        // Function to parse CSV data
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current); // Add the last value
                
                if (values.length === headers.length) {
                    const entry = {};
                    headers.forEach((header, index) => {
                        entry[header] = values[index].replace(/"/g, '');
                    });
                    data.push(entry);
                }
            }
            return data;
        }

        // Function to load CSV data
        async function loadScheduleData() {
            try {
                const response = await fetch('duties_and_agenda.csv');
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                console.error('Error loading CSV file:', error);
                return [];
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            // Load schedule data from CSV file
            const scheduleData = await loadScheduleData();
            
            if (scheduleData.length === 0) {
                console.error('No schedule data loaded');
                return;
            }

            const CONFIG = {
                DAYS_ORDER: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                SELECTORS: {
                    swiperWrapper: '.swiper-wrapper',
                    filterPanel: '#filter-panel',
                    filterTrigger: '#filter-trigger-btn',
                    expandedFilters: '#role-filters-expanded',
                    quickNav: '#quick-nav',
                },
                LOCAL_STORAGE_KEY: 'duties-calendar-preferences',
            };

            const state = { roles: [], processedData: {} };
            
            const timeToMinutes = (timeStr) => {
                if (!timeStr || typeof timeStr !== 'string' || !timeStr.includes(':')) return null;
                const [time, period] = timeStr.split(' ');
                if (!time || !period) return null;
                let [hours, minutes] = time.split(':').map(Number);
                if (isNaN(hours) || isNaN(minutes)) return null;
                if (period.toLowerCase() === 'pm' && hours !== 12) hours += 12;
                if (period.toLowerCase() === 'am' && hours === 12) hours = 0;
                return hours * 60 + minutes;
            };

            const minutesToTime = (minutes) => {
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                const hour12 = h % 12 === 0 ? 12 : h % 12;
                const period = h >= 12 && h < 24 ? 'PM' : 'AM';
                return `${hour12}:${m.toString().padStart(2, '0')} ${period}`;
            };
            
            const createMobileAbbreviation = (roleName) => {
                // Handle Agenda
                if (roleName === 'Agenda') return 'AG';
                
                // Handle AC patterns (AC 1 -> 1, AC 2 -> 2, etc.)
                const acMatch = roleName.match(/^AC (\d+)$/);
                if (acMatch) return acMatch[1];
                
                // Handle CN patterns (CN A -> A, CN B -> B, etc.)
                const cnMatch = roleName.match(/^CN ([A-Z])$/);
                if (cnMatch) return cnMatch[1];
                
                // For other patterns, return the original
                return roleName;
            };
            
            // Function to get color styling for role activities
            const getActivityColor = (activityData) => {
                // Handle simple string case (Free)
                if (typeof activityData === 'string') {
                    if (activityData === 'Free') {
                        return {
                            backgroundColor: '#f8f9fa',
                            borderColor: '#6c757d',
                            textColor: '#6c757d'
                        };
                    }
                    // Fallback for other strings
                    return {
                        backgroundColor: '#d1e7dd',
                        borderColor: '#198754',
                        textColor: '#0f5132'
                    };
                }
                
                // Handle object case with eventType
                if (activityData && activityData.eventType) {
                    const eventType = activityData.eventType.toLowerCase();
                    
                    switch (eventType) {
                        case 'break':
                            return {
                                backgroundColor: '#fff3cd',
                                borderColor: '#ffc107',
                                textColor: '#856404'
                            };
                        case 'meeting':
                            return {
                                backgroundColor: '#cff4fc',
                                borderColor: '#0dcaf0',
                                textColor: '#055160'
                            };
                        case 'duty':
                            return {
                                backgroundColor: '#d1e7dd',
                                borderColor: '#198754',
                                textColor: '#0f5132'
                            };
                        case 'agenda':
                            return {
                                backgroundColor: '#dbe4ff',
                                borderColor: '#6385ff',
                                textColor: '#0a58ca'
                            };
                        case 'free':
                            return {
                                backgroundColor: '#f8f9fa',
                                borderColor: '#6c757d',
                                textColor: '#6c757d'
                            };
                        default:
                            // Default for unknown types
                            return {
                                backgroundColor: '#d1e7dd',
                                borderColor: '#198754',
                                textColor: '#0f5132'
                            };
                    }
                }
                
                // Fallback
                return {
                    backgroundColor: '#d1e7dd',
                    borderColor: '#198754',
                    textColor: '#0f5132'
                };
            };
            
            // Function to regenerate card views for all days
            function regenerateCardViews() {
                CONFIG.DAYS_ORDER.forEach(day => {
                    const slide = document.querySelector(`.swiper-slide[data-day="${day}"]`);
                    if (slide) {
                        const cardView = slide.querySelector('.card-view');
                        if (cardView) {
                            const newCardHTML = generateCardViewForDay(day);
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = newCardHTML;
                            const newCardView = tempDiv.querySelector('.card-view');
                            
                            // Preserve the active class if it exists
                            if (cardView.classList.contains('active')) {
                                newCardView.classList.add('active');
                            }
                            
                            // Replace the old card view with the new one
                            cardView.parentNode.replaceChild(newCardView, cardView);
                        }
                    }
                });
            }
            const updateColumnAbbreviations = () => {
                // Update all calendar tables
                document.querySelectorAll('.calendar').forEach(calendar => {
                    // Count visible non-Agenda header columns in this specific calendar
                    const headerCols = calendar.querySelectorAll('th.role-col[data-role]');
                    const visibleNonAgendaCols = Array.from(headerCols).filter(col => {
                        const isVisible = col.style.display !== 'none';
                        const role = col.querySelector('.full-text')?.textContent;
                        return isVisible && role !== 'Agenda';
                    });
                    
                    if (visibleNonAgendaCols.length > 7) {
                        calendar.classList.add('many-columns');
                    } else {
                        calendar.classList.remove('many-columns');
                    }
                });
            };
            
            function preprocessData(data) {
                const allRoles = new Set();
                const processed = {};
                CONFIG.DAYS_ORDER.forEach(day => processed[day] = []);
                data.forEach(event => {
                    if (event.Role) allRoles.add(event.Role);
                    const startMins = timeToMinutes(event['Start Time']);
                    const endMins = timeToMinutes(event['End Time']);
                    if (event.Weekday && processed[event.Weekday] && startMins !== null) {
                        processed[event.Weekday].push({
                            ...event,
                            startMins,
                            endMins: endMins === null ? startMins + 15 : endMins,
                        });
                    }
                });
                state.roles = [...allRoles].sort((a, b) => {
                    if (a === 'Agenda') return -1; if (b === 'Agenda') return 1;
                    return a.localeCompare(b, undefined, { numeric: true });
                });
                state.processedData = processed;
            }

            function generateCalendarForDay(day) {
                const dayEvents = state.processedData[day];
                if (!dayEvents || dayEvents.length === 0) {
                    return `<div class="calendar-wrapper" style="display:flex; align-items:center; justify-content:center;"><p>No events for ${day}.</p></div>`;
                }
                const allTimes = dayEvents.flatMap(e => [e.startMins, e.endMins]).filter(t => t !== null);
                if (allTimes.length === 0) return `<div class="calendar-wrapper"><p>No valid events for ${day}.</p></div>`;
                const minTime = Math.min(...allTimes);
                const maxTime = Math.max(...allTimes);
                const eventGrid = {};
                state.roles.forEach(role => { eventGrid[role] = {}; });
                dayEvents.forEach(event => {
                    if (!event.Role || !eventGrid[event.Role] || event.endMins <= event.startMins) return;
                    eventGrid[event.Role][event.startMins] = { ...event, isStart: true, duration: event.endMins - event.startMins };
                    for (let t = event.startMins + 5; t < event.endMins; t += 5) {
                        eventGrid[event.Role][t] = { isSpanned: true };
                    }
                });
                let tableRows = '';
                for (let t = minTime; t < maxTime; t += 5) {
                    tableRows += `<tr data-time-minutes="${t}"><td class="time-col">${minutesToTime(t)}</td>`;
                    state.roles.forEach(role => {
                        const eventAtTime = eventGrid[role]?.[t];
                        const roleClass = role.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        if (eventAtTime?.isStart) {
                            const rowspan = Math.max(1, Math.floor(eventAtTime.duration / 5));
                            const eventHtml = `
                                <div class="event event-type-${eventAtTime['Event Type'].toLowerCase()} tooltip" data-event-name="${eventAtTime['Event Name'].toLowerCase()}">
                                    <div>
                                        <span class="event-full"><strong>${eventAtTime['Event Abbreviation']}</strong> - ${eventAtTime['Event Name']}</span>
                                        <span class="event-abbr-only"><strong>${eventAtTime['Event Abbreviation']}</strong></span>
                                    </div>
                                    <span class="tooltiptext">
                                        <strong>${eventAtTime['Event Name']}</strong><br>
                                        <strong>Time:</strong> ${eventAtTime['Start Time']} - ${eventAtTime['End Time']}<br>
                                        <strong>Role:</strong> ${eventAtTime.Role}<br>
                                        <strong>Type:</strong> ${eventAtTime['Event Type']}<br>
                                        <strong>Description:</strong> ${eventAtTime['Event Description']}
                                    </span>
                                </div>`;
                            tableRows += `<td class="role-col" data-role="${roleClass}" rowspan="${rowspan}">${eventHtml}</td>`;
                        } else if (!eventAtTime?.isSpanned) {
                            tableRows += `<td class="role-col" data-role="${roleClass}"></td>`;
                        }
                    });
                    tableRows += `</tr>`;
                }
                
                // Initially don't apply many-columns class - let updateColumnAbbreviations handle it
                const manyColumnsClass = '';
                
                const tableHeader = `<thead><tr><th class="time-col">Time</th>${state.roles.map(r => {
                    const roleClass = r.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    const mobileAbbr = createMobileAbbreviation(r);
                    return `<th class="role-col" data-role="${roleClass}">
                        <span class="full-text">${r}</span>
                        <span class="mobile-abbr">${mobileAbbr}</span>
                    </th>`;
                }).join('')}</tr></thead>`;
                
                return `<div class="calendar-wrapper"><table class="calendar ${manyColumnsClass}">${tableHeader}<tbody>${tableRows}</tbody></table></div>`;
            }
            
            function generateCardViewForDay(day) {
                const dayEvents = state.processedData[day];
                if (!dayEvents || dayEvents.length === 0) {
                    return `<div class="card-view"><div class="no-events-card">No events for ${day}.</div></div>`;
                }
                
                // Get only agenda events and sort by time
                const agendaEvents = dayEvents
                    .filter(event => event['Event Type'] && event['Event Type'].toLowerCase() === 'agenda')
                    .sort((a, b) => a.startMins - b.startMins);
                
                if (agendaEvents.length === 0) {
                    return `<div class="card-view"><div class="no-events-card">No agenda events for ${day}.</div></div>`;
                }
                
                let cardsHTML = '';
                
                agendaEvents.forEach(agendaEvent => {
                    // Find what each role is doing during this agenda event
                    const roleActivities = {};
                    
                    // Initialize all roles (except filtered out ones), plus paired AC/CN roles
                    state.roles.forEach(role => {
                        if (role !== 'Agenda') {
                            const roleClass = role.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                            // Check if role is currently visible (not filtered out)
                            const isRoleVisible = document.querySelector(`[data-role="${roleClass}"]`)?.style.display !== 'none';
                            if (isRoleVisible) {
                                roleActivities[role] = 'Free';
                                
                                // If this is an AC role, also include its paired CN role even if filtered out
                                const acMatch = role.match(/^AC (\d+)$/);
                                if (acMatch) {
                                    const acNumber = parseInt(acMatch[1]);
                                    const pairedCnLetter = String.fromCharCode('A'.charCodeAt(0) + acNumber - 1);
                                    const pairedCnRole = `CN ${pairedCnLetter}`;
                                    // Add the paired CN role if it exists in the data
                                    if (state.roles.includes(pairedCnRole)) {
                                        roleActivities[pairedCnRole] = 'Free';
                                    }
                                }
                                
                                // If this is a CN role, also include its paired AC role even if filtered out
                                const cnMatch = role.match(/^CN ([A-Z])$/);
                                if (cnMatch) {
                                    const cnLetter = cnMatch[1];
                                    const acNumber = cnLetter.charCodeAt(0) - 'A'.charCodeAt(0) + 1;
                                    const pairedAcRole = `AC ${acNumber}`;
                                    // Add the paired AC role if it exists in the data
                                    if (state.roles.includes(pairedAcRole)) {
                                        roleActivities[pairedAcRole] = 'Free';
                                    }
                                }
                            }
                        }
                    });
                    
                    // Find concurrent events for other roles (only include visible roles)
                    dayEvents.forEach(event => {
                        if (event.Role && event.Role !== 'Agenda' && 
                            event.startMins < agendaEvent.endMins && 
                            event.endMins > agendaEvent.startMins) {
                            // Check if this role should be included
                            if (roleActivities.hasOwnProperty(event.Role)) {
                                // This event overlaps with the agenda event
                                roleActivities[event.Role] = {
                                    activity: `${event['Event Abbreviation']} - ${event['Event Name']}`,
                                    eventType: event['Event Type']
                                };
                            }
                        }
                    });
                    
                    // Generate role assignments HTML with paired columns
                    const roleAssignmentsHTML = (() => {
                        const roleEntries = Object.entries(roleActivities);
                        
                        // Separate AC and CN roles, and other roles
                        const acRoles = roleEntries.filter(([role]) => role.startsWith('AC '));
                        const cnRoles = roleEntries.filter(([role]) => role.startsWith('CN '));
                        const otherRoles = roleEntries.filter(([role]) => !role.startsWith('AC ') && !role.startsWith('CN '));
                        
                        // Sort AC and CN roles numerically/alphabetically
                        acRoles.sort(([a], [b]) => a.localeCompare(b, undefined, { numeric: true }));
                        cnRoles.sort(([a], [b]) => a.localeCompare(b, undefined, { numeric: true }));
                        
                        let html = '';
                        
                        // Create specific AC/CN pairings (AC 1 with CN A, AC 2 with CN B, etc.)
                        // Convert roles to maps for easier lookup
                        const acRoleMap = new Map();
                        const cnRoleMap = new Map();
                        
                        acRoles.forEach(([role, activityData]) => {
                            const match = role.match(/^AC (\d+)$/);
                            if (match) {
                                acRoleMap.set(parseInt(match[1]), [role, activityData]);
                            }
                        });
                        
                        cnRoles.forEach(([role, activityData]) => {
                            const match = role.match(/^CN ([A-Z])$/);
                            if (match) {
                                // Convert letter to number (A=1, B=2, etc.)
                                const letterNumber = match[1].charCodeAt(0) - 'A'.charCodeAt(0) + 1;
                                cnRoleMap.set(letterNumber, [role, activityData]);
                            }
                        });
                        
                        // Find all AC numbers that exist
                        const allAcNumbers = [...acRoleMap.keys(), ...cnRoleMap.keys()];
                        const maxAcNumber = allAcNumbers.length > 0 ? Math.max(...allAcNumbers) : 0;
                        
                        // Create pairs and track for dividers
                        const visibleRows = [];
                        
                        for (let acNumber = 1; acNumber <= maxAcNumber; acNumber++) {
                            const acRole = acRoleMap.get(acNumber);
                            const cnRole = cnRoleMap.get(acNumber);
                            
                            // Only create a row if at least one role exists
                            if (acRole || cnRole) {
                                visibleRows.push(acNumber);
                                
                                html += '<div class="role-pair">';
                                
                                // Add AC role if exists, otherwise add invisible placeholder
                                if (acRole) {
                                    const [role, activityData] = acRole;
                                    const colors = getActivityColor(activityData);
                                    const displayText = typeof activityData === 'string' ? activityData : activityData.activity;
                                    html += `
                                        <div class="role-assignment" style="background-color: ${colors.backgroundColor}; border-left-color: ${colors.borderColor};">
                                            <div class="role-name">${role}</div>
                                            <div class="role-activity" style="color: ${colors.textColor};">${displayText}</div>
                                        </div>
                                    `;
                                } else {
                                    // Invisible placeholder for AC column when no AC role but CN role exists
                                    html += '<div class="role-assignment" style="visibility: hidden;"></div>';
                                }
                                
                                // Add CN role if exists, otherwise add invisible placeholder
                                if (cnRole) {
                                    const [role, activityData] = cnRole;
                                    const colors = getActivityColor(activityData);
                                    const displayText = typeof activityData === 'string' ? activityData : activityData.activity;
                                    html += `
                                        <div class="role-assignment" style="background-color: ${colors.backgroundColor}; border-left-color: ${colors.borderColor};">
                                            <div class="role-name">${role}</div>
                                            <div class="role-activity" style="color: ${colors.textColor};">${displayText}</div>
                                        </div>
                                    `;
                                } else {
                                    // Invisible placeholder for CN column when no CN role but AC role exists
                                    html += '<div class="role-assignment" style="visibility: hidden;"></div>';
                                }
                                
                                html += '</div>';
                            }
                        }
                        
                        // Add dividers based on AC number grouping (1-2, 3-4, 5-6, etc.)
                        if (visibleRows.length > 0) {
                            // Insert dividers by going through visible rows and adding dividers after every second AC number
                            let htmlWithDividers = '';
                            const rowsArray = html.split('<div class="role-pair">').filter(part => part.trim());
                            
                            for (let i = 0; i < visibleRows.length; i++) {
                                const acNumber = visibleRows[i];
                                const isLastRow = i === visibleRows.length - 1;
                                const isEvenAcNumber = acNumber % 2 === 0;
                                
                                // Add the role pair
                                if (i === 0) {
                                    htmlWithDividers += '<div class="role-pair">' + rowsArray[i];
                                } else {
                                    htmlWithDividers += '<div class="role-pair">' + rowsArray[i];
                                }
                                
                                // Add divider after even AC numbers (2, 4, 6, etc.) but not after the last row
                                if (isEvenAcNumber && !isLastRow) {
                                    htmlWithDividers += '<div class="role-pair-divider"></div>';
                                }
                                // Special case: if there's only one visible row from an odd-even pair, add dividers above and below
                                else if (!isEvenAcNumber && !isLastRow) {
                                    const nextVisibleAcNumber = visibleRows[i + 1];
                                    // If next number is not the immediate next (i.e., the even pair is missing), add divider
                                    if (nextVisibleAcNumber !== acNumber + 1) {
                                        htmlWithDividers += '<div class="role-pair-divider"></div>';
                                    }
                                }
                            }
                            
                            html = htmlWithDividers;
                        }
                        
                        // Add other roles in pairs
                        for (let i = 0; i < otherRoles.length; i += 2) {
                            html += '<div class="role-pair">';
                            
                            for (let j = 0; j < 2 && (i + j) < otherRoles.length; j++) {
                                const [role, activityData] = otherRoles[i + j];
                                const colors = getActivityColor(activityData);
                                const displayText = typeof activityData === 'string' ? activityData : activityData.activity;
                                html += `
                                    <div class="role-assignment" style="background-color: ${colors.backgroundColor}; border-left-color: ${colors.borderColor};">
                                        <div class="role-name">${role}</div>
                                        <div class="role-activity" style="color: ${colors.textColor};">${displayText}</div>
                                    </div>
                                `;
                            }
                            
                            html += '</div>';
                        }
                        
                        return html;
                    })();
                    
                    cardsHTML += `
                        <div class="agenda-card">
                            <div class="card-header">
                                <h3 class="card-title">${agendaEvent['Event Name']}</h3>
                                <div class="card-time">${agendaEvent['Start Time']} - ${agendaEvent['End Time']}</div>
                            </div>
                            <div class="card-description">${agendaEvent['Event Description']}</div>
                            <div class="card-roles">
                                ${roleAssignmentsHTML}
                            </div>
                        </div>
                    `;
                });
                
                return `<div class="card-view">${cardsHTML}</div>`;
            }
            
            function populateFilters() {
                const filterControls = `<div class="filter-controls"><button class="filter-control-btn" data-action="select-all">Select All</button><button class="filter-control-btn" data-action="deselect-all">Deselect All</button></div>`;
                
                // Separate and organize roles like in the card view
                const allRoles = state.roles.filter(role => role !== 'Agenda');
                const acRoles = allRoles.filter(role => role.startsWith('AC '));
                const cnRoles = allRoles.filter(role => role.startsWith('CN '));
                const otherRoles = allRoles.filter(role => !role.startsWith('AC ') && !role.startsWith('CN '));
                
                // Sort AC and CN roles numerically/alphabetically
                acRoles.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
                cnRoles.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
                
                // Create AC/CN role maps for pairing
                const acRoleMap = new Map();
                const cnRoleMap = new Map();
                
                acRoles.forEach(role => {
                    const match = role.match(/^AC (\d+)$/);
                    if (match) {
                        acRoleMap.set(parseInt(match[1]), role);
                    }
                });
                
                cnRoles.forEach(role => {
                    const match = role.match(/^CN ([A-Z])$/);
                    if (match) {
                        const letterNumber = match[1].charCodeAt(0) - 'A'.charCodeAt(0) + 1;
                        cnRoleMap.set(letterNumber, role);
                    }
                });
                
                // Generate role options in paired order
                let roleOptionsHTML = '';
                
                // Add AC/CN pairs first
                const maxAcNumber = Math.max(...[...acRoleMap.keys(), ...cnRoleMap.keys()], 0);
                for (let acNumber = 1; acNumber <= maxAcNumber; acNumber++) {
                    const acRole = acRoleMap.get(acNumber);
                    const cnRole = cnRoleMap.get(acNumber);
                    
                    // Add AC role if it exists
                    if (acRole) {
                        const roleClass = acRole.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        roleOptionsHTML += `<div class="role-option"><input type="checkbox" id="dd-role-${roleClass}" value="${roleClass}" checked><label for="dd-role-${roleClass}">${acRole}</label></div>`;
                    }
                    
                    // Add CN role if it exists
                    if (cnRole) {
                        const roleClass = cnRole.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        roleOptionsHTML += `<div class="role-option"><input type="checkbox" id="dd-role-${roleClass}" value="${roleClass}" checked><label for="dd-role-${roleClass}">${cnRole}</label></div>`;
                    }
                }
                
                // Add other roles at the end
                otherRoles.forEach(role => {
                    const roleClass = role.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    roleOptionsHTML += `<div class="role-option"><input type="checkbox" id="dd-role-${roleClass}" value="${roleClass}" checked><label for="dd-role-${roleClass}">${role}</label></div>`;
                });
                
                // Only populate the dropdown filter panel
                document.querySelector(CONFIG.SELECTORS.filterPanel).innerHTML = filterControls + '<div class="filter-options-grid">' + roleOptionsHTML + '</div>';
            }

            // Function to update active day button
            function updateActiveDayButton(swiper) {
                // Use requestAnimationFrame to ensure this runs after any DOM updates
                requestAnimationFrame(() => {
                    const currentDay = swiper.slides[swiper.activeIndex].dataset.day;
                    // Force remove active class from all buttons first
                    document.querySelectorAll('.quick-nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                        // Aggressively clear all inline styles on mobile
                        btn.style.removeProperty('background');
                        btn.style.removeProperty('background-color');
                        btn.style.removeProperty('color');
                        btn.style.removeProperty('border-color');
                        // Also reset to default values
                        btn.style.background = '#ffffff';
                        btn.style.color = '#343a40';
                        btn.style.borderColor = '#dee2e6';
                    });
                    
                    // Then add active class to the current day button
                    const currentDayButton = document.querySelector(`.quick-nav-btn[data-day="${currentDay}"]`);
                    if (currentDayButton) {
                        currentDayButton.classList.add('active');
                        // Force the active styling on mobile
                        currentDayButton.style.background = '#007bff';
                        currentDayButton.style.color = 'white';
                        currentDayButton.style.borderColor = '#007bff';
                        
                        // Additional force reflow on mobile
                        currentDayButton.offsetHeight;
                    }
                });
            }

            function updateCurrentTimeIndicator(swiper) {
                const now = new Date();
                const today = now.toLocaleDateString('en-US', { weekday: 'long' });
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                document.querySelectorAll('.current-time-indicator').forEach(el => el.remove());
                const activeSlide = swiper.slides[swiper.activeIndex];
                if (activeSlide.dataset.day === today) {
                    const timeRow = activeSlide.querySelector(`tr[data-time-minutes="${currentMinutes - (currentMinutes % 5)}"]`);
                    if (timeRow) {
                        const indicator = document.createElement('div');
                        indicator.className = 'current-time-indicator';
                        const timeCell = timeRow.querySelector('.time-col');
                        if (timeCell) {
                           timeCell.style.position = 'relative';
                              timeCell.appendChild(indicator);
                        }
                    }
                }
            }

            function setupEventListeners(swiper) {
                const filterTrigger = document.querySelector(CONFIG.SELECTORS.filterTrigger);
                const filterPanel = document.querySelector(CONFIG.SELECTORS.filterPanel);
                filterTrigger.addEventListener('click', () => filterPanel.classList.toggle('active'));
                document.addEventListener('click', (e) => {
                    if (!filterPanel.contains(e.target) && !filterTrigger.contains(e.target)) {
                        filterPanel.classList.remove('active');
                    }
                });
                document.querySelector(CONFIG.SELECTORS.quickNav).addEventListener('click', (e) => {
                    if (e.target.matches('.quick-nav-btn[data-day]')) {
                        const dayIndex = CONFIG.DAYS_ORDER.indexOf(e.target.dataset.day);
                        if (dayIndex !== -1) {
                            swiper.slideTo(dayIndex);
                        }
                    }
                });
                const filterContainers = [filterPanel];
                filterContainers.forEach(container => {
                    container.addEventListener('click', (e) => {
                        const target = e.target;
                        if (target.matches('input[type="checkbox"]')) {
                            const role = target.value;
                            const isVisible = target.checked;
                            document.querySelectorAll(`input[value="${role}"]`).forEach(cb => cb.checked = isVisible);
                            document.querySelectorAll(`[data-role="${role}"]`).forEach(el => el.style.display = isVisible ? '' : 'none');
                            updateColumnAbbreviations(); // Update abbreviations when filters change
                            regenerateCardViews(); // Update card views when filters change
                            savePreferences();
                        } else if (target.matches('.filter-control-btn')) {
                            const isSelectAll = target.dataset.action === 'select-all';
                            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                                if (cb.checked !== isSelectAll) cb.click();
                            });
                            updateColumnAbbreviations(); // Update abbreviations after bulk changes
                            regenerateCardViews(); // Update card views after bulk changes
                        }
                    });
                });
            }

            function savePreferences() {
                const filters = Array.from(document.querySelectorAll('#filter-panel input[type="checkbox"]')).map(cb => ({ value: cb.value, checked: cb.checked }));
                const isCardView = document.querySelector('.card-view.active') !== null;
                localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, JSON.stringify({ filters, isCardView }));
            }

            function loadPreferences() {
                const saved = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
                if (!saved) return { isCardView: true }; // Default to card view
                
                const { filters, isCardView = true } = JSON.parse(saved); // Default to card view if not set
                
                // Apply filter preferences
                if (filters) {
                    filters.forEach(filter => {
                        document.querySelectorAll(`input[value="${filter.value}"]`).forEach(cb => cb.checked = filter.checked);
                        document.querySelectorAll(`[data-role="${filter.value}"]`).forEach(el => el.style.display = filter.checked ? '' : 'none');
                    });
                }
                
                updateColumnAbbreviations(); // Update abbreviations after loading preferences
                
                return { isCardView };
            }

            function initialize() {
                preprocessData(scheduleData);
                const swiperWrapper = document.querySelector(CONFIG.SELECTORS.swiperWrapper);
                
                // Generate slides with both table and card views
                swiperWrapper.innerHTML = CONFIG.DAYS_ORDER.map(day => `
                    <div class="swiper-slide" data-day="${day}">
                        <div class="table-view">
                            ${generateCalendarForDay(day)}
                        </div>
                        ${generateCardViewForDay(day)}
                    </div>
                `).join('');
                
                populateFilters();
                const preferences = loadPreferences();
                updateColumnAbbreviations(); // Initial abbreviation update after calendar generation
                
                // Regenerate card views after filters are applied to ensure they respect saved preferences
                regenerateCardViews();
                
                const swiper = new Swiper('.swiper', {
                    navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
                    keyboard: { enabled: true },
                    on: {
                        slideChangeTransitionEnd: function () {
                            updateActiveDayButton(this);
                            updateCurrentTimeIndicator(this);
                        }
                    }
                });
                
                setupEventListeners(swiper);
                setupViewToggle(preferences.isCardView);
                
                const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
                const todayIndex = CONFIG.DAYS_ORDER.indexOf(today);
                if (todayIndex !== -1) {
                    swiper.slideTo(todayIndex, 0);
                }
                if (swiper.slides.length > 0) {
                     swiper.emit('slideChangeTransitionEnd');
                }
                setInterval(() => updateCurrentTimeIndicator(swiper), 60000);
            }

            function setupViewToggle(initialIsCardView = true) {
                const viewToggleBtn = document.getElementById('view-toggle-btn');
                let isCardView = initialIsCardView;
                
                // Set initial view state
                if (isCardView) {
                    viewToggleBtn.textContent = 'Table View';
                    document.querySelectorAll('.swiper-slide').forEach(slide => {
                        const tableView = slide.querySelector('.table-view');
                        const cardView = slide.querySelector('.card-view');
                        tableView.classList.remove('active');
                        cardView.classList.add('active');
                    });
                } else {
                    viewToggleBtn.textContent = 'Card View';
                    document.querySelectorAll('.swiper-slide').forEach(slide => {
                        const tableView = slide.querySelector('.table-view');
                        const cardView = slide.querySelector('.card-view');
                        tableView.classList.add('active');
                        cardView.classList.remove('active');
                    });
                }
                
                viewToggleBtn.addEventListener('click', () => {
                    isCardView = !isCardView;
                    
                    // Update button text only (no active state)
                    if (isCardView) {
                        viewToggleBtn.textContent = 'Table View';
                    } else {
                        viewToggleBtn.textContent = 'Card View';
                    }
                    
                    // Toggle views in all slides
                    document.querySelectorAll('.swiper-slide').forEach(slide => {
                        const tableView = slide.querySelector('.table-view');
                        const cardView = slide.querySelector('.card-view');
                        
                        if (isCardView) {
                            tableView.classList.remove('active');
                            cardView.classList.add('active');
                        } else {
                            tableView.classList.add('active');
                            cardView.classList.remove('active');
                        }
                    });
                    
                    // Save the preference
                    savePreferences();
                });
            }

            initialize();
        });
    </script>
</body>
</html>