<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duties Calendar</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

    <style>
        :root {
            --primary-color: #007bff;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --border-color: #dee2e6;
            --text-color: #343a40;
            --white: #ffffff;
            --danger-color: #ff4444;
        }
        html, body {
            overflow: hidden;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            color: var(--text-color);
            background-color: var(--light-gray);
        }
        .calendar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .swiper-container {
            flex-grow: 1;
            min-height: 0;
            position: relative;
        }
        .swiper {
            height: 100%;
        }
        .calendar-wrapper {
            overflow-y: auto;
            overflow-x: hidden;
            height: 100%;
        }
        .table-view {
            display: none;
            height: 100%;
        }
        .table-view.active {
            display: block;
        }

        .calendar-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--light-gray);
            border-bottom: 1px solid var(--border-color);
            transform: translateY(0);
            transition: transform 0.3s ease-in-out;
            margin: -1rem -1rem 0.5rem -1rem;
            padding: 1rem;
        }
        .calendar-header.hidden {
            transform: translateY(-100%);
        }
        .navigation-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            margin-top: 0.5rem;
        }
        .swiper-button-next, .swiper-button-prev {
            position: static !important;
            margin: 0 !important;
            width: auto;
            height: auto;
            color: var(--primary-color);
        }
        .swiper-button-prev:after, .swiper-button-next:after {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .calendar-toolbar {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
            align-items: center;
            flex-wrap: nowrap;
        }
        .filter-container, .view-toggle-container, .duties-summary-container {
            display: flex;
            justify-content: center;
            position: relative;
            flex: 1;
            min-width: 0;
        }
        .control-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            background-color: var(--white);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            max-width: 140px;
        }
        .control-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .control-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .control-btn.view-toggle:hover {
            background-color: var(--medium-gray);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        #filter-trigger-btn:after {
            content: '▼';
            font-size: 0.7em;
            margin-left: 5px;
        }
        .filter-dropdown-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            box-sizing: border-box;
        }
        .filter-dropdown-panel.active {
            display: flex;
        }
        .filter-dropdown-content {
            background-color: var(--white);
            min-width: 300px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 2rem;
            position: relative;
        }
        .filter-dropdown-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .filter-dropdown-close:hover {
            background-color: var(--light-gray);
        }
        .filter-dropdown-header {
            margin-bottom: 1.5rem;
            padding-right: 2rem;
        }
        .filter-dropdown-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
            margin: 0;
        }
        .role-filters-expanded {
            display: none;
        }
        .filter-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            justify-content: center;
        }
        .filter-control-btn {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            background: var(--white);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .filter-control-btn:hover {
            background: var(--light-gray);
        }
        .filter-options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: flex-start;
        }
        .role-option {
            display: block;
            width: calc(50% - 0.25rem);
            margin-bottom: 0.25rem;
        }
        .role-option input[type="checkbox"] { 
            display: none; 
        }
        .role-option label {
            display: block;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            background: #f1f3f5;
            color: #343a40;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            border: 1px solid var(--border-color);
            user-select: none;
            text-align: center;
            font-size: 0.875rem;
            width: 100%;
            box-sizing: border-box;
        }
        .role-option input[type="checkbox"]:checked + label {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }
        
        .role-option.ac-role input[type="checkbox"]:checked + label {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .quick-nav {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
            margin: 0;
            flex-grow: 1;
        }
        .quick-nav-btn {
            flex-grow: 1;
            flex-basis: 0;
            padding: 0.5rem 0.25rem;
            border: 1px solid var(--border-color);
            background: var(--white);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
            text-align: center;
            white-space: nowrap;
        }
        .quick-nav-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .quick-nav-btn.active {
            background: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
        }
        .color-key-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.25rem 1rem;
            margin: 0;
        }
        .key-item {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            color: #555;
        }
        .key-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 6px;
            display: inline-block;
            flex-shrink: 0;
        }

        .card-view {
            display: none;
            padding: 0.5rem;
            gap: 1rem;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
        }
        .card-view.active {
            display: flex;
        }
        .agenda-card {
            background: var(--white);
            border: 2px solid #6385ff;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--text-color);
            margin: 0;
        }
        .card-time {
            font-size: 0.9rem;
            color: #666;
            background: var(--light-gray);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            white-space: nowrap;
            font-weight: 500;
        }
        .card-description {
            color: #555;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        .card-roles {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .role-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        .role-assignment {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: 0.375rem;
            border-left: 4px solid var(--primary-color);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .role-assignment:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .role-name {
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }
        .role-name .name-assignment {
            font-weight: normal;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .role-activity {
            color: #555;
            font-size: 0.9rem;
        }
        .no-events-card {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
        }
        .role-pair-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, var(--border-color), transparent);
            margin: 0.25rem 0;
            position: relative;
        }
        .role-pair-divider::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background: var(--border-color);
            border-radius: 50%;
        }

        .calendar {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            max-width: 100%;
        }
        .calendar th {
            position: sticky;
            top: 0;
            z-index: 3;
            background-color: var(--medium-gray);
            padding: 0.75rem 0.5rem;
            font-weight: bold;
            border-bottom: 2px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .calendar th, .calendar td {
            border: 1px solid var(--border-color);
            padding: 0;
            text-align: center;
            vertical-align: top;
            word-break: break-word;
        }
        .calendar td.role-col {
            height: 40px;
            vertical-align: stretch;
        }
        .calendar th.time-col, .calendar td.time-col {
            position: sticky;
            left: 0;
            background: #f1f3f5;
            z-index: 2;
            padding: 0.75rem;
            font-weight: bold;
            width: 60px;
        }
        .calendar th.time-col {
            z-index: 4;
        }
        .calendar th.role-col .full-text {
            display: inline;
        }
        .calendar th.role-col .mobile-abbr {
            display: none;
        }
        .event-abbr-only {
            display: none;
        }
        .calendar.many-columns .event-full {
            display: none;
        }
        .calendar.many-columns .event-abbr-only {
            display: inline;
        }
        .event {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 0.25rem;
            font-size: 0.85rem;
            text-align: left;
            display: flex;
            align-items: flex-start;
            box-sizing: border-box;
            padding: 0.5rem;
            white-space: normal;
            min-height: 100%;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .event:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1;
        }
        .event > div:first-child {
            position: -webkit-sticky;
            position: sticky;
            top: 48px;
        }
        .event-type-free { background-color: #f8f9fa; border-left: 3px solid #6c757d; }
        .event-type-break { background-color: #fff3cd; border-left: 3px solid #ffc107; }
        .event-type-meeting { background-color: #cff4fc; border-left: 3px solid #0dcaf0; }
        .event-type-duty { background-color: #d1e7dd; border-left: 3px solid #198754; }
        .event-type-agenda { background-color: #dbe4ff; border-left: 3px solid #6385ff; }
        @media (max-width: 768px) {
            .calendar.many-columns th.role-col .full-text {
                display: none;
            }
            .calendar.many-columns th.role-col .mobile-abbr {
                display: inline;
            }
        }
        .current-time-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--danger-color);
            z-index: 10;
            box-shadow: 0 0 5px rgba(255, 68, 68, 0.5);
            pointer-events: none;
        }
        .current-time-indicator::before {
            content: '';
            position: absolute;
            left: -5px;
            top: -4px;
            width: 10px;
            height: 10px;
            background: var(--danger-color);
            border-radius: 50%;
        }
        
        /* Modal Styles */
        .role-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            box-sizing: border-box;
        }
        .role-modal.active {
            display: flex;
        }
        .role-modal-content {
            background: var(--white);
            border-radius: 0.5rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative;
        }
        .role-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .role-modal-close:hover {
            background-color: var(--light-gray);
        }
        .role-modal-header {
            margin-bottom: 1.5rem;
            padding-right: 2rem;
        }
        .role-modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
            margin: 0 0 0.5rem 0;
        }
        .role-modal-time {
            font-size: 1rem;
            color: #666;
            background: var(--light-gray);
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            display: inline-block;
        }
        .role-modal-section {
            margin-bottom: 1.5rem;
        }
        .role-modal-section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.25rem;
        }
        .role-modal-activity {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }
        .role-modal-activity-name {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .role-modal-activity-type {
            font-size: 0.9rem;
            color: #666;
            text-transform: capitalize;
        }
        .role-modal-names {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .role-modal-name-tag {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .role-modal-name-tag.ac-role {
            background: #28a745;
        }
        .role-modal-description {
            color: #555;
            line-height: 1.5;
        }
        
        /* Duties Summary Modal Styles */
        .duties-summary-modal-content {
            max-width: 90vw;
            max-height: 90vh;
            width: 1000px;
        }
        
        .duties-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .duties-summary-column {
            background: var(--light-gray);
            border-radius: 0.375rem;
            padding: 1rem;
            border-left: 4px solid var(--border-color);
        }
        
        .duties-summary-column h3 {
            font-size: 1rem;
            font-weight: bold;
            color: var(--text-color);
            margin: 0 0 0.75rem 0;
            text-align: center;
            background: var(--primary-color);
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        
        .duties-summary-column h3.ac-role {
            background: #28a745;
            color: white;
        }
        
        .duties-summary-column ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .duties-summary-column li {
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            color: var(--text-color);
        }
        
        .duties-summary-column li:last-child {
            border-bottom: none;
        }
        
        .duties-summary-column li:before {
            content: "• ";
            color: var(--text-color);
            font-weight: bold;
            margin-right: 0.25rem;
        }
        
        /* Name Search Dropdown Styles */
        .name-search-section {
            margin-bottom: 0.75rem;
        }
        
        .name-search-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .name-search-input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            font-size: 1rem;
            border: 2px solid var(--border-color);
            background-color: var(--white);
            border-radius: 0.5rem;
            outline: none;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        
        .name-search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .name-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 0.25rem 0.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .name-search-dropdown.active {
            display: block;
        }
        
        .name-search-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--light-gray);
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        
        .name-search-option:hover {
            background-color: var(--light-gray);
        }
        
        .name-search-option:last-child {
            border-bottom: none;
        }
        
        .name-search-option.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .name-search-option .name-role {
            font-weight: bold;
            color: var(--text-color);
        }
        
        .name-search-option.selected .name-role {
            color: white;
        }
        
        .name-search-option .name-full {
            font-size: 0.8rem;
            color: #666;
            margin-left: 0.5rem;
        }
        
        .name-search-option.selected .name-full {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .name-search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.4rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .name-search-clear:hover {
            background-color: var(--light-gray);
            color: var(--primary-color);
        }
        
        .name-search-clear.active {
            display: flex;
        }
        
        /* Highlighted role styles - REMOVED */
        
        @media (max-width: 768px) {
            .duties-summary-modal-content {
                width: 95vw;
                max-height: 85vh;
                padding: 1rem;
            }
            
            .duties-summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 0.75rem;
            }
            
            .duties-summary-column {
                padding: 0.75rem;
            }
            
            .duties-summary-column h3 {
                font-size: 0.9rem;
            }
            
            .duties-summary-column li {
                font-size: 0.8rem;
            }
            
            .name-search-dropdown {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90vw;
                max-width: 400px;
                max-height: 60vh;
                border-radius: 0.5rem;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            }
        }
        @media (max-width: 768px) {
            .time-col, .calendar th.time-col, .calendar td.time-col {
                width: 45px !important;
                font-size: 0.7rem;
                padding: 0.25rem !important;
            }
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .card-title {
                font-size: 1.1rem;
            }
        }
        @media (max-width: 480px) {
            .calendar-toolbar {
                gap: 0.5rem;
            }
            .control-btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.8rem;
                max-width: 120px;
            }
            .name-search-input {
                padding: 0.5rem 2rem 0.5rem 0.75rem;
                font-size: 0.9rem;
            }
            .name-search-clear {
                right: 8px;
                width: 20px;
                height: 20px;
                font-size: 1.2rem;
            }
            .color-key-container {
                gap: 0.15rem 0.5rem;
            }
            .key-item {
                font-size: 0.65rem;
            }
            .agenda-card {
                padding: 1rem;
            }
            .card-title {
                font-size: 1rem;
            }
        }
        @media print {
            body { overflow: visible !important; height: auto; }
            .calendar-header { display: none !important; }
            .calendar-container { position: static !important; height: auto !important; overflow: visible !important; }
            .swiper-container, .swiper { height: auto !important; overflow: visible; }
            .swiper-wrapper { display: block !important; }
            .swiper-slide { display: block !important; page-break-inside: avoid; margin-bottom: 2rem; }
            .event > div:first-child { position: static; }
        }
    </style>
</head>
<body>
    <div id="calendar-container" class="calendar-container">
        <header class="calendar-header" id="calendar-header">
            <section class="name-search-section">
                <div class="name-search-container">
                    <input type="text" 
                           id="name-search-input" 
                           class="name-search-input" 
                           placeholder="Search names..."
                           autocomplete="off">
                    <button class="name-search-clear" id="name-search-clear" title="Clear search">&times;</button>
                    <div class="name-search-dropdown" id="name-search-dropdown">
                        <!-- Options will be populated by JavaScript -->
                    </div>
                </div>
            </section>
            
            <section class="calendar-toolbar">
                <div class="duties-summary-container">
                    <button id="duties-summary-btn" class="control-btn">
                        Summary
                    </button>
                </div>
                <div class="filter-container">
                    <button id="filter-trigger-btn" class="control-btn">Filter Roles</button>
                </div>
                <div class="view-toggle-container">
                    <button id="view-toggle-btn" class="control-btn view-toggle">
                        Table View
                    </button>
                </div>
            </section>
            
            <section class="color-key-container">
                <div class="key-item"><span class="key-color" style="background-color: #dbe4ff;"></span>Main Agenda</div>
                <div class="key-item"><span class="key-color" style="background-color: #d1e7dd;"></span>Duty</div>
                <div class="key-item"><span class="key-color" style="background-color: #cff4fc;"></span>Meeting</div>
                <div class="key-item"><span class="key-color" style="background-color: #fff3cd;"></span>Break/Off</div>
                <div class="key-item"><span class="key-color" style="background-color: #f8f9fa; border: 1px solid #dee2e6;"></span>Free</div>
            </section>

            <section class="role-filters-expanded" id="role-filters-expanded" style="display: none;"></section>

            <nav class="navigation-controls">
                <button class="swiper-button-prev"></button>
                <div class="quick-nav" id="quick-nav">
                    <button class="quick-nav-btn" data-day="Sunday">Sun</button>
                    <button class="quick-nav-btn" data-day="Monday">Mon</button>
                    <button class="quick-nav-btn" data-day="Tuesday">Tue</button>
                    <button class="quick-nav-btn" data-day="Wednesday">Wed</button>
                    <button class="quick-nav-btn" data-day="Thursday">Thu</button>
                    <button class="quick-nav-btn" data-day="Friday">Fri</button>
                    <button class="quick-nav-btn" data-day="Saturday">Sat</button>
                </div>
                <button class="swiper-button-next"></button>
            </nav>
        </header>

        <main class="swiper-container">
            <div class="swiper">
                <div class="swiper-wrapper">
                    </div>
            </div>
        </main>
    </div>

    <!-- Filter Modal -->
    <div id="filter-panel" class="filter-dropdown-panel">
        <div class="filter-dropdown-content">
            <button class="filter-dropdown-close" id="filter-dropdown-close">&times;</button>
            <div class="filter-dropdown-header">
                <h2 class="filter-dropdown-title">Filter Roles</h2>
            </div>
            <div id="filter-content">
                <!-- Filter content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Role Details Modal -->
    <div id="role-modal" class="role-modal">
        <div class="role-modal-content">
            <button class="role-modal-close" id="role-modal-close">&times;</button>
            <div class="role-modal-header">
                <h2 class="role-modal-title" id="role-modal-title"></h2>
                <div class="role-modal-time" id="role-modal-time"></div>
            </div>
            <div class="role-modal-section">
                <h3 class="role-modal-section-title">Assigned Staff</h3>
                <div class="role-modal-names" id="role-modal-names"></div>
            </div>
            <div class="role-modal-section" id="role-modal-description-section">
                <h3 class="role-modal-section-title">Activity Description</h3>
                <div class="role-modal-description" id="role-modal-description"></div>
            </div>
        </div>
    </div>

    <!-- Duties Summary Modal -->
    <div id="duties-summary-modal" class="role-modal">
        <div class="role-modal-content duties-summary-modal-content">
            <button class="role-modal-close" id="duties-summary-modal-close">&times;</button>
            <div class="role-modal-header">
                <h2 class="role-modal-title">AC Role Duties Summary</h2>
            </div>
            <div class="duties-summary-grid">
                <!-- Duties will be populated here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
   
    <script>
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current);
                
                if (values.length === headers.length) {
                    const entry = {};
                    headers.forEach((header, index) => {
                        entry[header] = values[index].replace(/"/g, '');
                    });
                    data.push(entry);
                }
            }
            return data;
        }

        async function loadScheduleData() {
            try {
                const response = await fetch('duties_and_agenda.csv');
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                console.error('Error loading CSV file:', error);
                return [];
            }
        }

        async function loadRoleAssignments() {
                try {
                    const response = await fetch('role_assignments.csv');
                    const csvText = await response.text();
                    const data = parseCSV(csvText);
                    
                    // Create a mapping from role to names (for display) and full names (for modal)
                    const roleNameMap = {};
                    const roleFullNamesMap = {};
                    const allNames = []; // New array to store all names for search
                    
                    data.forEach(row => {
                        const role = row.role;
                        const name = row.name;
                        
                        if (!roleNameMap[role]) {
                            roleNameMap[role] = [];
                            roleFullNamesMap[role] = [];
                        }
                        
                        // For AC roles, store the first name for display
                        if (role.startsWith('AC ')) {
                            const firstName = name.replace('AC ', '').split(' ')[0];
                            roleNameMap[role] = [firstName];
                            roleFullNamesMap[role] = [name.replace('AC ', '')];
                            // Add to all names array
                            allNames.push({
                                role: role,
                                displayName: firstName,
                                fullName: name.replace('AC ', ''),
                                searchText: `${firstName} ${name.replace('AC ', '')}`.toLowerCase()
                            });
                        } else if (role.startsWith('CN ')) {
                            // For CN roles, store full names for modal and don't use display names in table
                            const fullName = name.replace('CN ', '');
                            roleFullNamesMap[role].push(fullName);
                            // Add to all names array
                            allNames.push({
                                role: role,
                                displayName: fullName.split(' ')[0],
                                fullName: fullName,
                                searchText: fullName.toLowerCase()
                            });
                        } else {
                            // For other roles, store the name as-is
                            roleFullNamesMap[role].push(name);
                            // Add to all names array
                            allNames.push({
                                role: role,
                                displayName: name.split(' ')[0],
                                fullName: name,
                                searchText: name.toLowerCase()
                            });
                        }
                    });
                    
                    return { roleNameMap, roleFullNamesMap, allNames };
                } catch (error) {
                    console.error('Error loading role assignments:', error);
                    return { roleNameMap: {}, roleFullNamesMap: {}, allNames: [] };
                }
            }

        // Global state to make it accessible to all functions
        let globalState = {};

        document.addEventListener('DOMContentLoaded', async function () {
            const scheduleData = await loadScheduleData();
            const { roleNameMap, roleFullNamesMap, allNames } = await loadRoleAssignments();
            
            if (scheduleData.length === 0) {
                console.error('No schedule data loaded');
                return;
            }

            const CONFIG = {
                DAYS_ORDER: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                SELECTORS: {
                    swiperWrapper: '.swiper-wrapper',
                    filterPanel: '#filter-panel',
                    filterTrigger: '#filter-trigger-btn',
                    expandedFilters: '#role-filters-expanded',
                    quickNav: '#quick-nav',
                },
                LOCAL_STORAGE_KEY: 'duties-calendar-preferences',
            };

            const state = { roles: [], processedData: {}, roleAssignments: roleNameMap, roleFullNames: roleFullNamesMap, allNames: allNames };
            globalState = state; // Make state accessible globally
            
            const timeToMinutes = (timeStr) => {
                if (!timeStr || typeof timeStr !== 'string' || !timeStr.includes(':')) return null;
                const [time, period] = timeStr.split(' ');
                if (!time || !period) return null;
                let [hours, minutes] = time.split(':').map(Number);
                if (isNaN(hours) || isNaN(minutes)) return null;
                if (period.toLowerCase() === 'pm' && hours !== 12) hours += 12;
                if (period.toLowerCase() === 'am' && hours === 12) hours = 0;
                return hours * 60 + minutes;
            };

            const minutesToTime = (minutes) => {
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                const hour12 = h % 12 === 0 ? 12 : h % 12;
                const period = h >= 12 && h < 24 ? 'PM' : 'AM';
                return `${hour12}:${m.toString().padStart(2, '0')} ${period}`;
            };
            
            const createMobileAbbreviation = (roleName) => {
                if (roleName === 'Agenda') return 'AG';
                const acMatch = roleName.match(/^AC (\d+)$/);
                if (acMatch) return acMatch[1];
                const cnMatch = roleName.match(/^CN ([A-Z])$/);
                if (cnMatch) return cnMatch[1];
                return roleName;
            };
            
            const formatRoleNameWithAssignments = (roleName) => {
                const assignments = state.roleAssignments[roleName];
                if (assignments && assignments.length > 0) {
                    return `${roleName} <span class="name-assignment">(${assignments[0]})</span>`;
                }
                return roleName;
            };
            
            const getActivityColor = (activityData) => {
                if (typeof activityData === 'string') {
                    if (activityData === 'Free' || activityData === 'No Duty') {
                        return {
                            backgroundColor: '#f8f9fa',
                            borderColor: '#6c757d',
                            textColor: '#6c757d'
                        };
                    }
                    return {
                        backgroundColor: '#d1e7dd',
                        borderColor: '#198754',
                        textColor: '#0f5132'
                    };
                }
                
                if (activityData && activityData.eventType) {
                    const eventType = activityData.eventType.toLowerCase();
                    const colors = {
                        'break': { backgroundColor: '#fff3cd', borderColor: '#ffc107', textColor: '#856404' },
                        'meeting': { backgroundColor: '#cff4fc', borderColor: '#0dcaf0', textColor: '#055160' },
                        'duty': { backgroundColor: '#d1e7dd', borderColor: '#198754', textColor: '#0f5132' },
                        'agenda': { backgroundColor: '#dbe4ff', borderColor: '#6385ff', textColor: '#0a58ca' },
                        'free': { backgroundColor: '#f8f9fa', borderColor: '#6c757d', textColor: '#6c757d' }
                    };
                    return colors[eventType] || colors['duty'];
                }
                
                return {
                    backgroundColor: '#d1e7dd',
                    borderColor: '#198754',
                    textColor: '#0f5132'
                };
            };
            
            // Track if we need to update views when modal closes
            let needsViewUpdate = false;
            
            // Global state for name search filtering
            let nameSearchState = {
                isActive: false,
                selectedRole: null,
                adjacentRole: null
            };
            
            // Function to apply all filter changes
            function applyFilterChanges() {
                if (needsViewUpdate) {
                    updateColumnAbbreviations();
                    // Only regenerate card views if we're currently in card view mode
                    if (document.querySelector('.card-view.active')) {
                        regenerateCardViews();
                    }
                    needsViewUpdate = false;
                }
            }
            
            function regenerateCardViews() {
                // Use requestAnimationFrame for better performance
                requestAnimationFrame(() => {
                    CONFIG.DAYS_ORDER.forEach(day => {
                        const slide = document.querySelector(`.swiper-slide[data-day="${day}"]`);
                        if (slide) {
                            const cardView = slide.querySelector('.card-view');
                            if (cardView) {
                                const newCardHTML = generateCardViewForDay(day);
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = newCardHTML;
                                const newCardView = tempDiv.querySelector('.card-view');
                                
                                if (cardView.classList.contains('active')) {
                                    newCardView.classList.add('active');
                                }
                                
                                cardView.parentNode.replaceChild(newCardView, cardView);
                            }
                        }
                    });
                });
            }
            
            function updateRoleFilterCheckboxes(selectedRole, adjacentRole = null) {
                // Uncheck all role filters first
                document.querySelectorAll('.role-option input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Check the selected role, adjacent role (if exists), and Agenda
                const selectedRoleClass = selectedRole.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                const agendaRoleClass = 'agenda';
                
                const selectedCheckbox = document.querySelector(`input[value="${selectedRoleClass}"]`);
                if (selectedCheckbox) {
                    selectedCheckbox.checked = true;
                }
                
                if (adjacentRole) {
                    const adjacentRoleClass = adjacentRole.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    const adjacentCheckbox = document.querySelector(`input[value="${adjacentRoleClass}"]`);
                    if (adjacentCheckbox) {
                        adjacentCheckbox.checked = true;
                    }
                }
                
                const agendaCheckbox = document.querySelector(`input[value="${agendaRoleClass}"]`);
                if (agendaCheckbox) {
                    agendaCheckbox.checked = true;
                }
            }
            
            function clearNameSearch() {
                const searchInput = document.getElementById('name-search-input');
                const searchDropdown = document.getElementById('name-search-dropdown');
                const clearButton = document.getElementById('name-search-clear');
                
                if (searchInput) searchInput.value = '';
                if (searchDropdown) searchDropdown.classList.remove('active');
                if (clearButton) clearButton.classList.remove('active');
                
                nameSearchState.isActive = false;
                nameSearchState.selectedRole = null;
                nameSearchState.adjacentRole = null;
            }
            
            function getAdjacentRole(role) {
                // AC roles: AC 1 pairs with AC 2, AC 3 pairs with AC 4, AC 5 pairs with AC 6, etc.
                const acMatch = role.match(/^AC (\d+)$/);
                if (acMatch) {
                    const acNumber = parseInt(acMatch[1]);
                    // If odd, pair with next even number; if even, pair with previous odd number
                    const adjacentNumber = acNumber % 2 === 1 ? acNumber + 1 : acNumber - 1;
                    return `AC ${adjacentNumber}`;
                }
                
                // CN roles: CN A pairs with CN B, CN C pairs with CN D, CN E pairs with CN F, etc.
                const cnMatch = role.match(/^CN ([A-Z])$/);
                if (cnMatch) {
                    const cnLetter = cnMatch[1];
                    const letterIndex = cnLetter.charCodeAt(0) - 'A'.charCodeAt(0); // 0 for A, 1 for B, etc.
                    
                    // If even index (A, C, E...), pair with next letter; if odd index (B, D, F...), pair with previous letter
                    const adjacentIndex = letterIndex % 2 === 0 ? letterIndex + 1 : letterIndex - 1;
                    const adjacentLetter = String.fromCharCode('A'.charCodeAt(0) + adjacentIndex);
                    return `CN ${adjacentLetter}`;
                }
                
                // For other roles, no adjacent pairing
                return null;
            }
            
            const updateColumnAbbreviations = () => {
                document.querySelectorAll('.calendar').forEach(calendar => {
                    const headerCols = calendar.querySelectorAll('th.role-col[data-role]');
                    const visibleNonAgendaCols = Array.from(headerCols).filter(col => {
                        const isVisible = col.style.display !== 'none';
                        const role = col.querySelector('.full-text')?.textContent;
                        return isVisible && role !== 'Agenda';
                    });
                    
                    if (visibleNonAgendaCols.length > 7) {
                        calendar.classList.add('many-columns');
                    } else {
                        calendar.classList.remove('many-columns');
                    }
                });
            };
            
            function preprocessData(data) {
                // First, create merged events from the raw data
                const mergedEvents = createMergedEvents(data);
                
                const allRoles = new Set();
                const processed = {};
                CONFIG.DAYS_ORDER.forEach(day => processed[day] = []);
                
                // Process merged events instead of raw data
                mergedEvents.forEach(event => {
                    // Add all roles from this event to the role set
                    event.assignedRoles.forEach(role => allRoles.add(role));
                    
                    const startMins = timeToMinutes(event.startTime);
                    const endMins = timeToMinutes(event.endTime);
                    if (event.weekday && processed[event.weekday] && startMins !== null) {
                        processed[event.weekday].push({
                            ...event,
                            startMins,
                            endMins: endMins === null ? startMins + 15 : endMins,
                        });
                    }
                });
                
                state.roles = [...allRoles].sort((a, b) => {
                    if (a === 'Agenda') return -1; if (b === 'Agenda') return 1;
                    return a.localeCompare(b, undefined, { numeric: true });
                });
                state.processedData = processed;
            }
            
            function createMergedEvents(rawData) {
                const eventMap = new Map();
                
                rawData.forEach(row => {
                    // Create a unique key for events that should be merged
                    const key = `${row.Weekday}-${row['Start Time']}-${row['End Time']}-${row['Event Name']}-${row['Event Type']}`;
                    
                    if (eventMap.has(key)) {
                        // Event already exists, add this role to it
                        const existingEvent = eventMap.get(key);
                        existingEvent.assignedRoles.push(row.Role);
                    } else {
                        // Create new merged event
                        const mergedEvent = {
                            weekday: row.Weekday,
                            startTime: row['Start Time'],
                            endTime: row['End Time'],
                            eventName: row['Event Name'],
                            eventAbbreviation: row['Event Abbreviation'],
                            eventType: row['Event Type'],
                            eventDescription: row['Event Description'],
                            assignedRoles: [row.Role],
                            // Keep original structure for backward compatibility
                            'Event Name': row['Event Name'],
                            'Event Abbreviation': row['Event Abbreviation'],
                            'Event Type': row['Event Type'],
                            'Event Description': row['Event Description'],
                            'Start Time': row['Start Time'],
                            'End Time': row['End Time'],
                            'Weekday': row.Weekday,
                            'Role': row.Role // This will be the first role, but we'll use assignedRoles for the full list
                        };
                        eventMap.set(key, mergedEvent);
                    }
                });
                
                return Array.from(eventMap.values());
            }

            function generateCalendarForDay(day) {
                const dayEvents = state.processedData[day];
                if (!dayEvents || dayEvents.length === 0) {
                    return `<div class="calendar-wrapper" style="display:flex; align-items:center; justify-content:center;"><p>No events for ${day}.</p></div>`;
                }
                const allTimes = dayEvents.flatMap(e => [e.startMins, e.endMins]).filter(t => t !== null);
                if (allTimes.length === 0) return `<div class="calendar-wrapper"><p>No valid events for ${day}.</p></div>`;
                const minTime = Math.min(...allTimes);
                const maxTime = Math.max(...allTimes);
                const eventGrid = {};
                state.roles.forEach(role => { eventGrid[role] = {}; });
                
                dayEvents.forEach(event => {
                    // For each role assigned to this event, add it to the grid
                    event.assignedRoles.forEach(role => {
                        if (!eventGrid[role] || event.endMins <= event.startMins) return;
                        eventGrid[role][event.startMins] = { 
                            ...event, 
                            isStart: true, 
                            duration: event.endMins - event.startMins,
                            Role: role // Set the current role for this cell
                        };
                        for (let t = event.startMins + 5; t < event.endMins; t += 5) {
                            eventGrid[role][t] = { isSpanned: true };
                        }
                    });
                });
                
                let tableRows = '';
                for (let t = minTime; t < maxTime; t += 5) {
                    tableRows += `<tr data-time-minutes="${t}"><td class="time-col">${minutesToTime(t)}</td>`;
                    state.roles.forEach(role => {
                        const eventAtTime = eventGrid[role]?.[t];
                        const roleClass = role.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        if (eventAtTime?.isStart) {
                            const rowspan = Math.max(1, Math.floor(eventAtTime.duration / 5));
                            const eventHtml = `
                                <div class="event event-type-${eventAtTime['Event Type'].toLowerCase()} clickable-event" 
                                     data-role="${eventAtTime.Role}" 
                                     data-activity="${eventAtTime['Event Abbreviation']} - ${eventAtTime['Event Name']}" 
                                     data-description="${eventAtTime['Event Description']}" 
                                     data-event-time="${eventAtTime['Start Time']} - ${eventAtTime['End Time']}" 
                                     data-event-name="${eventAtTime['Event Name']}"
                                     data-event-type="${eventAtTime['Event Type']}">
                                    <div>
                                        <span class="event-full"><strong>${eventAtTime['Event Abbreviation']}</strong> - ${eventAtTime['Event Name']}</span>
                                        <span class="event-abbr-only"><strong>${eventAtTime['Event Abbreviation']}</strong></span>
                                    </div>
                                </div>`;
                            tableRows += `<td class="role-col" data-role="${roleClass}" rowspan="${rowspan}">${eventHtml}</td>`;
                        } else if (!eventAtTime?.isSpanned) {
                            tableRows += `<td class="role-col" data-role="${roleClass}"></td>`;
                        }
                    });
                    tableRows += `</tr>`;
                }
                
                // Initially don't apply many-columns class - let updateColumnAbbreviations handle it
                const manyColumnsClass = '';
                
                const tableHeader = `<thead><tr><th class="time-col">Time</th>${state.roles.map(r => {
                    const roleClass = r.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    const mobileAbbr = createMobileAbbreviation(r);
                    return `<th class="role-col" data-role="${roleClass}">
                        <span class="full-text">${r}</span>
                        <span class="mobile-abbr">${mobileAbbr}</span>
                    </th>`;
                }).join('')}</tr></thead>`;
                
                return `<div class="calendar-wrapper"><table class="calendar ${manyColumnsClass}">${tableHeader}<tbody>${tableRows}</tbody></table></div>`;
            }
            
            function generateCardViewForDay(day) {
                const dayEvents = state.processedData[day];
                if (!dayEvents || dayEvents.length === 0) {
                    return `<div class="card-view"><div class="no-events-card">No events for ${day}.</div></div>`;
                }
                
                // Get only significant agenda events (excluding travel/transition) and sort by time
                const agendaEvents = dayEvents
                    .filter(event => {
                        if (!event['Event Type'] || event['Event Type'].toLowerCase() !== 'agenda') {
                            return false;
                        }
                        // Filter out travel/transition-related agenda events
                        const eventName = event['Event Name'] || '';
                        const lowerEventName = eventName.toLowerCase();
                        return !lowerEventName.includes('travel') && 
                               !lowerEventName.includes('transition') && 
                               !lowerEventName.includes('move to') &&
                               !lowerEventName.includes('roll call');
                    })
                    .sort((a, b) => a.startMins - b.startMins);
                
                if (agendaEvents.length === 0) {
                    return `<div class="card-view"><div class="no-events-card">No agenda events for ${day}.</div></div>`;
                }
                
                let cardsHTML = '';
                
                agendaEvents.forEach(agendaEvent => {
                    // Find what each role is doing during this agenda event using the new hierarchy
                    const roleActivities = getRoleActivitiesForAgendaEvent(agendaEvent, dayEvents);
                    
                    // Generate role assignments HTML with paired columns
                    const roleAssignmentsHTML = generateRoleAssignmentsHTML(roleActivities, agendaEvent, dayEvents);
                    
                    cardsHTML += `
                        <div class="agenda-card">
                            <div class="card-header">
                                <h3 class="card-title">${agendaEvent['Event Name']}</h3>
                                <div class="card-time">${agendaEvent['Start Time']} - ${agendaEvent['End Time']}</div>
                            </div>
                            <div class="card-description">${agendaEvent['Event Description']}</div>
                            <div class="card-roles">
                                ${roleAssignmentsHTML}
                            </div>
                        </div>
                    `;
                });
                
                return `<div class="card-view">${cardsHTML}</div>`;
            }
            
            function getRoleActivitiesForAgendaEvent(agendaEvent, dayEvents) {
                const roleActivities = {};
                
                // Initialize only visible roles (don't auto-include paired roles yet)
                state.roles.forEach(role => {
                    if (role !== 'Agenda') {
                        const roleClass = role.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        // Check if role is currently visible (not filtered out)
                        const isRoleVisible = document.querySelector(`[data-role="${roleClass}"]`)?.style.display !== 'none';
                        if (isRoleVisible) {
                            roleActivities[role] = null; // Start with null, will be filled based on hierarchy
                        }
                    }
                });
                
                // Find events for each role and determine which roles actually have assignments
                const rolesWithAssignments = new Set();
                
                dayEvents.forEach(event => {
                    if (event['Event Type'] && event['Event Type'].toLowerCase() === 'agenda') {
                        return; // Skip agenda events
                    }
                    
                    // Check if this event overlaps with the agenda event
                    const isOverlapping = event.startMins < agendaEvent.endMins && event.endMins > agendaEvent.startMins;
                    const startsWithinAgenda = event.startMins >= agendaEvent.startMins && event.startMins < agendaEvent.endMins;
                    const isActiveAtAgendaStart = event.startMins <= agendaEvent.startMins && event.endMins > agendaEvent.startMins;
                    
                    if (isOverlapping || startsWithinAgenda || isActiveAtAgendaStart) {
                        // This event is relevant to the agenda event
                        event.assignedRoles.forEach(role => {
                            // Mark this role as having an assignment
                            rolesWithAssignments.add(role);
                            
                            // If this role is in our visible roles OR we need to add it for pairing
                            if (roleActivities.hasOwnProperty(role)) {
                                const currentActivity = roleActivities[role];
                                const newActivity = {
                                    activity: `${event['Event Abbreviation']} - ${event['Event Name']}`,
                                    eventType: event['Event Type'],
                                    startTime: event['Start Time'],
                                    endTime: event['End Time'],
                                    isOverlapping: isOverlapping,
                                    startsWithin: startsWithinAgenda,
                                    priority: getEventPriority(event['Event Type'])
                                };
                                
                                // Apply hierarchy rules
                                if (shouldReplaceActivity(currentActivity, newActivity)) {
                                    roleActivities[role] = newActivity;
                                }
                            }
                        });
                    }
                });
                
                // Now add paired roles only if they have actual assignments during this time
                const visibleRoles = Object.keys(roleActivities);
                visibleRoles.forEach(role => {
                    // If this is an AC role, check if its paired CN role has assignments
                    const acMatch = role.match(/^AC (\d+)$/);
                    if (acMatch) {
                        const acNumber = parseInt(acMatch[1]);
                        const pairedCnLetter = String.fromCharCode('A'.charCodeAt(0) + acNumber - 1);
                        const pairedCnRole = `CN ${pairedCnLetter}`;
                        if (state.roles.includes(pairedCnRole) && rolesWithAssignments.has(pairedCnRole) && !roleActivities.hasOwnProperty(pairedCnRole)) {
                            // Add the paired CN role and find its activity
                            roleActivities[pairedCnRole] = null;
                            
                            // Find the CN role's activity during this agenda event
                            dayEvents.forEach(event => {
                                if (event['Event Type'] && event['Event Type'].toLowerCase() === 'agenda') {
                                    return; // Skip agenda events
                                }
                                
                                const isOverlapping = event.startMins < agendaEvent.endMins && event.endMins > agendaEvent.startMins;
                                const startsWithinAgenda = event.startMins >= agendaEvent.startMins && event.startMins < agendaEvent.endMins;
                                const isActiveAtAgendaStart = event.startMins <= agendaEvent.startMins && event.endMins > agendaEvent.startMins;
                                
                                if ((isOverlapping || startsWithinAgenda || isActiveAtAgendaStart) && event.assignedRoles.includes(pairedCnRole)) {
                                    const currentActivity = roleActivities[pairedCnRole];
                                    const newActivity = {
                                        activity: `${event['Event Abbreviation']} - ${event['Event Name']}`,
                                        eventType: event['Event Type'],
                                        startTime: event['Start Time'],
                                        endTime: event['End Time'],
                                        isOverlapping: isOverlapping,
                                        startsWithin: startsWithinAgenda,
                                        priority: getEventPriority(event['Event Type'])
                                    };
                                    
                                    if (shouldReplaceActivity(currentActivity, newActivity)) {
                                        roleActivities[pairedCnRole] = newActivity;
                                    }
                                }
                            });
                        }
                    }
                    
                    // If this is a CN role, check if its paired AC role has assignments
                    const cnMatch = role.match(/^CN ([A-Z])$/);
                    if (cnMatch) {
                        const cnLetter = cnMatch[1];
                        const acNumber = cnLetter.charCodeAt(0) - 'A'.charCodeAt(0) + 1;
                        const pairedAcRole = `AC ${acNumber}`;
                        if (state.roles.includes(pairedAcRole) && rolesWithAssignments.has(pairedAcRole) && !roleActivities.hasOwnProperty(pairedAcRole)) {
                            // Add the paired AC role and find its activity
                            roleActivities[pairedAcRole] = null;
                            
                            // Find the AC role's activity during this agenda event
                            dayEvents.forEach(event => {
                                if (event['Event Type'] && event['Event Type'].toLowerCase() === 'agenda') {
                                    return; // Skip agenda events
                                }
                                
                                const isOverlapping = event.startMins < agendaEvent.endMins && event.endMins > agendaEvent.startMins;
                                const startsWithinAgenda = event.startMins >= agendaEvent.startMins && event.startMins < agendaEvent.endMins;
                                const isActiveAtAgendaStart = event.startMins <= agendaEvent.startMins && event.endMins > agendaEvent.startMins;
                                
                                if ((isOverlapping || startsWithinAgenda || isActiveAtAgendaStart) && event.assignedRoles.includes(pairedAcRole)) {
                                    const currentActivity = roleActivities[pairedAcRole];
                                    const newActivity = {
                                        activity: `${event['Event Abbreviation']} - ${event['Event Name']}`,
                                        eventType: event['Event Type'],
                                        startTime: event['Start Time'],
                                        endTime: event['End Time'],
                                        isOverlapping: isOverlapping,
                                        startsWithin: startsWithinAgenda,
                                        priority: getEventPriority(event['Event Type'])
                                    };
                                    
                                    if (shouldReplaceActivity(currentActivity, newActivity)) {
                                        roleActivities[pairedAcRole] = newActivity;
                                    }
                                }
                            });
                        }
                    }
                });
                
                // Fill in any remaining null values with "No Duty"
                Object.keys(roleActivities).forEach(role => {
                    if (roleActivities[role] === null) {
                        roleActivities[role] = 'No Duty';
                    }
                });
                
                return roleActivities;
            }
            
            function getEventPriority(eventType) {
                const priorities = {
                    'duty': 1,    // Highest priority
                    'break': 2,   // Time off
                    'free': 3     // No duty - lowest priority
                };
                return priorities[eventType.toLowerCase()] || 1; // Default to duty priority
            }
            
            function shouldReplaceActivity(currentActivity, newActivity) {
                if (currentActivity === null || currentActivity === 'No Duty') {
                    return true; // Always replace null or "No Duty"
                }
                
                if (typeof currentActivity === 'string') {
                    return true; // Replace simple strings with detailed activity objects
                }
                
                if (typeof currentActivity === 'object' && typeof newActivity === 'object') {
                    // Lower priority number = higher priority
                    if (newActivity.priority < currentActivity.priority) {
                        return true; // New activity has higher priority
                    } else if (newActivity.priority === currentActivity.priority) {
                        // Same priority, use other criteria
                        if (newActivity.isOverlapping && !currentActivity.isOverlapping) {
                            return true; // Prefer overlapping events
                        } else if (newActivity.isOverlapping === currentActivity.isOverlapping) {
                            // Same overlap type, prefer longer duration
                            const currentDuration = timeToMinutes(currentActivity.endTime) - timeToMinutes(currentActivity.startTime);
                            const newDuration = timeToMinutes(newActivity.endTime) - timeToMinutes(newActivity.startTime);
                            if (newDuration > currentDuration) {
                                return true;
                            } else if (newDuration === currentDuration) {
                                // Same duration, prefer earlier start time
                                const currentStart = timeToMinutes(currentActivity.startTime);
                                const newStart = timeToMinutes(newActivity.startTime);
                                return newStart < currentStart;
                            }
                        }
                    }
                }
                
                return false; // Don't replace
            }
            
            function generateRoleAssignmentsHTML(roleActivities, agendaEvent, dayEvents) {
                const roleEntries = Object.entries(roleActivities);
                
                // Separate AC and CN roles, and other roles
                const acRoles = roleEntries.filter(([role]) => role.startsWith('AC '));
                const cnRoles = roleEntries.filter(([role]) => role.startsWith('CN '));
                const otherRoles = roleEntries.filter(([role]) => !role.startsWith('AC ') && !role.startsWith('CN '));
                
                // Sort AC and CN roles numerically/alphabetically
                acRoles.sort(([a], [b]) => a.localeCompare(b, undefined, { numeric: true }));
                cnRoles.sort(([a], [b]) => a.localeCompare(b, undefined, { numeric: true }));
                
                let html = '';
                
                // Create specific AC/CN pairings (AC 1 with CN A, AC 2 with CN B, etc.)
                const acRoleMap = new Map();
                const cnRoleMap = new Map();
                
                acRoles.forEach(([role, activityData]) => {
                    const match = role.match(/^AC (\d+)$/);
                    if (match) {
                        acRoleMap.set(parseInt(match[1]), [role, activityData]);
                    }
                });
                
                cnRoles.forEach(([role, activityData]) => {
                    const match = role.match(/^CN ([A-Z])$/);
                    if (match) {
                        const letterNumber = match[1].charCodeAt(0) - 'A'.charCodeAt(0) + 1;
                        cnRoleMap.set(letterNumber, [role, activityData]);
                    }
                });
                
                // Find all AC numbers that exist
                const allAcNumbers = [...acRoleMap.keys(), ...cnRoleMap.keys()];
                const maxAcNumber = allAcNumbers.length > 0 ? Math.max(...allAcNumbers) : 0;
                
                // Create pairs and track for dividers
                const visibleRows = [];
                
                for (let acNumber = 1; acNumber <= maxAcNumber; acNumber++) {
                    const acRole = acRoleMap.get(acNumber);
                    const cnRole = cnRoleMap.get(acNumber);
                    
                    // Only create a row if at least one role exists
                    if (acRole || cnRole) {
                        visibleRows.push(acNumber);
                        
                        html += '<div class="role-pair">';
                        
                        // Add AC role if exists, otherwise add invisible placeholder
                        if (acRole) {
                            html += generateRoleAssignmentHTML(acRole[0], acRole[1], agendaEvent, dayEvents);
                        } else {
                            html += '<div class="role-assignment" style="visibility: hidden;"></div>';
                        }
                        
                        // Add CN role if exists, otherwise add invisible placeholder
                        if (cnRole) {
                            html += generateRoleAssignmentHTML(cnRole[0], cnRole[1], agendaEvent, dayEvents);
                        } else {
                            html += '<div class="role-assignment" style="visibility: hidden;"></div>';
                        }
                        
                        html += '</div>';
                    }
                }
                
                // Add dividers based on AC number grouping (1-2, 3-4, 5-6, etc.)
                if (visibleRows.length > 0) {
                    let htmlWithDividers = '';
                    const rowsArray = html.split('<div class="role-pair">').filter(part => part.trim());
                    
                    for (let i = 0; i < visibleRows.length; i++) {
                        const acNumber = visibleRows[i];
                        const isLastRow = i === visibleRows.length - 1;
                        const isEvenAcNumber = acNumber % 2 === 0;
                        
                        // Add the role pair
                        if (i === 0) {
                            htmlWithDividers += '<div class="role-pair">' + rowsArray[i];
                        } else {
                            htmlWithDividers += '<div class="role-pair">' + rowsArray[i];
                        }
                        
                        // Add divider after even AC numbers (2, 4, 6, etc.) but not after the last row
                        if (isEvenAcNumber && !isLastRow) {
                            htmlWithDividers += '<div class="role-pair-divider"></div>';
                        }
                        // Special case: if there's only one visible row from an odd-even pair, add dividers above and below
                        else if (!isEvenAcNumber && !isLastRow) {
                            const nextVisibleAcNumber = visibleRows[i + 1];
                            // If next number is not the immediate next (i.e., the even pair is missing), add divider
                            if (nextVisibleAcNumber !== acNumber + 1) {
                                htmlWithDividers += '<div class="role-pair-divider"></div>';
                            }
                        }
                    }
                    
                    html = htmlWithDividers;
                }
                
                // Add other roles in pairs
                for (let i = 0; i < otherRoles.length; i += 2) {
                    html += '<div class="role-pair">';
                    
                    for (let j = 0; j < 2 && (i + j) < otherRoles.length; j++) {
                        const [role, activityData] = otherRoles[i + j];
                        html += generateRoleAssignmentHTML(role, activityData, agendaEvent, dayEvents);
                    }
                    
                    html += '</div>';
                }
                
                return html;
            }
            
            function generateRoleAssignmentHTML(role, activityData, agendaEvent, dayEvents) {
                const colors = getActivityColor(activityData);
                let displayText, timeIndicator = '';
                let assignmentTime = `${agendaEvent['Start Time']} - ${agendaEvent['End Time']}`; // Default to agenda time
                
                if (typeof activityData === 'string') {
                    displayText = activityData;
                } else {
                    displayText = activityData.activity;
                    // Use the specific assignment's time instead of agenda time
                    assignmentTime = `${activityData.startTime} - ${activityData.endTime}`;
                    
                    // Add time indicator if duty doesn't fully overlap with agenda
                    if (!activityData.isOverlapping) {
                        if (activityData.startsWithin) {
                            // Duty starts within agenda but ends after
                            timeIndicator = ` (starts ${activityData.startTime})`;
                        } else {
                            // Duty is active during agenda but has different time range
                            timeIndicator = ` (${activityData.startTime} - ${activityData.endTime})`;
                        }
                    }
                }
                
                const eventType = typeof activityData === 'object' ? activityData.eventType : (activityData === 'No Duty' ? 'Free' : 'Duty');
                const roleNameWithAssignments = formatRoleNameWithAssignments(role);
                const activityDescription = typeof activityData === 'object' ? 
                    dayEvents.find(e => e.assignedRoles.includes(role) && e.startMins < agendaEvent.endMins && e.endMins > agendaEvent.startMins)?.['Event Description'] || '' : '';
                
                return `
                    <div class="role-assignment" style="background-color: ${colors.backgroundColor}; border-left-color: ${colors.borderColor};" 
                         data-role="${role}" data-activity="${displayText}" data-description="${activityDescription}" 
                         data-event-time="${assignmentTime}" data-event-name="${agendaEvent['Event Name']}"
                         data-event-type="${eventType}">
                        <div class="role-name">${roleNameWithAssignments}</div>
                        <div class="role-activity" style="color: ${colors.textColor};">${displayText}${timeIndicator}</div>
                    </div>
                `;
            }
            
            function populateFilters() {
                const filterControls = `<div class="filter-controls"><button class="filter-control-btn" data-action="select-all">Select All</button><button class="filter-control-btn" data-action="deselect-all">Deselect All</button></div>`;
                
                // Separate and organize roles like in the card view
                const allRoles = state.roles.filter(role => role !== 'Agenda');
                const acRoles = allRoles.filter(role => role.startsWith('AC '));
                const cnRoles = allRoles.filter(role => role.startsWith('CN '));
                const otherRoles = allRoles.filter(role => !role.startsWith('AC ') && !role.startsWith('CN '));
                
                // Sort AC and CN roles numerically/alphabetically
                acRoles.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
                cnRoles.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
                
                // Create AC/CN role maps for pairing
                const acRoleMap = new Map();
                const cnRoleMap = new Map();
                
                acRoles.forEach(role => {
                    const match = role.match(/^AC (\d+)$/);
                    if (match) {
                        acRoleMap.set(parseInt(match[1]), role);
                    }
                });
                
                cnRoles.forEach(role => {
                    const match = role.match(/^CN ([A-Z])$/);
                    if (match) {
                        const letterNumber = match[1].charCodeAt(0) - 'A'.charCodeAt(0) + 1;
                        cnRoleMap.set(letterNumber, role);
                    }
                });
                
                // Generate role options in paired order
                let roleOptionsHTML = '';
                
                // Add AC/CN pairs first
                const maxAcNumber = Math.max(...[...acRoleMap.keys(), ...cnRoleMap.keys()], 0);
                for (let acNumber = 1; acNumber <= maxAcNumber; acNumber++) {
                    const acRole = acRoleMap.get(acNumber);
                    const cnRole = cnRoleMap.get(acNumber);
                    
                    // Add AC role if it exists
                    if (acRole) {
                        const roleClass = acRole.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        const assignments = state.roleAssignments[acRole];
                        const displayName = assignments && assignments.length > 0 ? `${acRole} (${assignments[0]})` : acRole;
                        roleOptionsHTML += `<div class="role-option ac-role"><input type="checkbox" id="dd-role-${roleClass}" value="${roleClass}" checked><label for="dd-role-${roleClass}">${displayName}</label></div>`;
                    }
                    
                    // Add CN role if it exists
                    if (cnRole) {
                        const roleClass = cnRole.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        roleOptionsHTML += `<div class="role-option"><input type="checkbox" id="dd-role-${roleClass}" value="${roleClass}" checked><label for="dd-role-${roleClass}">${cnRole}</label></div>`;
                    }
                }
                
                // Add other roles at the end
                otherRoles.forEach(role => {
                    const roleClass = role.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    roleOptionsHTML += `<div class="role-option"><input type="checkbox" id="dd-role-${roleClass}" value="${roleClass}" checked><label for="dd-role-${roleClass}">${role}</label></div>`;
                });
                
                // Populate the filter content area
                document.querySelector('#filter-content').innerHTML = filterControls + '<div class="filter-options-grid">' + roleOptionsHTML + '</div>';
            }

            // Function to update active day button
            function updateActiveDayButton(swiper) {
                requestAnimationFrame(() => {
                    const currentDay = swiper.slides[swiper.activeIndex].dataset.day;
                    document.querySelectorAll('.quick-nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.removeProperty('background');
                        btn.style.removeProperty('background-color');
                        btn.style.removeProperty('color');
                        btn.style.removeProperty('border-color');
                        btn.style.background = '#ffffff';
                        btn.style.color = '#343a40';
                        btn.style.borderColor = '#dee2e6';
                    });
                    
                    const currentDayButton = document.querySelector(`.quick-nav-btn[data-day="${currentDay}"]`);
                    if (currentDayButton) {
                        currentDayButton.classList.add('active');
                        currentDayButton.style.background = '#007bff';
                        currentDayButton.style.color = 'white';
                        currentDayButton.style.borderColor = '#007bff';
                        currentDayButton.offsetHeight;
                    }
                });
            }

            function updateCurrentTimeIndicator(swiper) {
                const now = new Date();
                const today = now.toLocaleDateString('en-US', { weekday: 'long' });
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                document.querySelectorAll('.current-time-indicator').forEach(el => el.remove());
                const activeSlide = swiper.slides[swiper.activeIndex];
                if (activeSlide.dataset.day === today) {
                    const timeRow = activeSlide.querySelector(`tr[data-time-minutes="${currentMinutes - (currentMinutes % 5)}"]`);
                    if (timeRow) {
                        const indicator = document.createElement('div');
                        indicator.className = 'current-time-indicator';
                        const timeCell = timeRow.querySelector('.time-col');
                        if (timeCell) {
                           timeCell.style.position = 'relative';
                              timeCell.appendChild(indicator);
                        }
                    }
                }
            }

            function setupEventListeners(swiper) {
                const filterTrigger = document.querySelector(CONFIG.SELECTORS.filterTrigger);
                const filterPanel = document.querySelector(CONFIG.SELECTORS.filterPanel);
                const filterClose = document.querySelector('#filter-dropdown-close');
                
                // Open filter modal
                filterTrigger.addEventListener('click', () => filterPanel.classList.add('active'));
                
                // Close filter modal
                filterClose.addEventListener('click', () => {
                    filterPanel.classList.remove('active');
                    applyFilterChanges(); // Apply changes when modal closes
                });
                
                // Close modal when clicking outside
                filterPanel.addEventListener('click', (e) => {
                    if (e.target === filterPanel) {
                        filterPanel.classList.remove('active');
                        applyFilterChanges(); // Apply changes when modal closes
                    }
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && filterPanel.classList.contains('active')) {
                        filterPanel.classList.remove('active');
                        applyFilterChanges(); // Apply changes when modal closes
                    }
                });
                
                document.querySelector(CONFIG.SELECTORS.quickNav).addEventListener('click', (e) => {
                    if (e.target.matches('.quick-nav-btn[data-day]')) {
                        const dayIndex = CONFIG.DAYS_ORDER.indexOf(e.target.dataset.day);
                        if (dayIndex !== -1) {
                            swiper.slideTo(dayIndex);
                        }
                    }
                });
                const filterContainers = [filterPanel];
                filterContainers.forEach(container => {
                    container.addEventListener('click', (e) => {
                        const target = e.target;
                        if (target.matches('input[type="checkbox"]')) {
                            // Check if a name search is active - if so, clear the name search and allow manual filtering
                            if (nameSearchState.isActive) {
                                clearNameSearch();
                            }
                            
                            const role = target.value;
                            const isVisible = target.checked;
                            document.querySelectorAll(`input[value="${role}"]`).forEach(cb => cb.checked = isVisible);
                            document.querySelectorAll(`[data-role="${role}"]`).forEach(el => el.style.display = isVisible ? '' : 'none');
                            needsViewUpdate = true; // Mark that we need to update views later
                            savePreferences();
                        } else if (target.matches('.filter-control-btn')) {
                            // Check if a name search is active - if so, clear the name search and allow bulk operations
                            if (nameSearchState.isActive) {
                                clearNameSearch();
                            }
                            
                            const isSelectAll = target.dataset.action === 'select-all';
                            // Bulk operation - update all at once without individual events
                            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                                if (cb.checked !== isSelectAll) {
                                    cb.checked = isSelectAll;
                                    const role = cb.value;
                                    document.querySelectorAll(`input[value="${role}"]`).forEach(syncCb => syncCb.checked = isSelectAll);
                                    document.querySelectorAll(`[data-role="${role}"]`).forEach(el => el.style.display = isSelectAll ? '' : 'none');
                                }
                            });
                            needsViewUpdate = true; // Mark that we need to update views later
                            savePreferences();
                        }
                    });
                });
            }

            function setupRoleModal() {
                const modal = document.getElementById('role-modal');
                const closeBtn = document.getElementById('role-modal-close');
                
                // Close modal handlers
                closeBtn.addEventListener('click', () => {
                    modal.classList.remove('active');
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.classList.contains('active')) {
                        modal.classList.remove('active');
                    }
                });
                
                // Role assignment and table event click handler
                document.addEventListener('click', (e) => {
                    // Check for role assignment clicks (card view)
                    const roleAssignment = e.target.closest('.role-assignment[data-role]');
                    if (roleAssignment) {
                        showRoleModal(roleAssignment);
                        return;
                    }
                    
                    // Check for table event clicks (table view)
                    const tableEvent = e.target.closest('.event[data-role]');
                    if (tableEvent) {
                        showRoleModal(tableEvent);
                        return;
                    }
                });
            }

            function showRoleModal(element) {
                const role = element.dataset.role;
                const activity = element.dataset.activity;
                const description = element.dataset.description;
                const eventTime = element.dataset.eventTime;
                const eventName = element.dataset.eventName;
                const eventType = element.dataset.eventType;
                
                // Simple approach: Just show staff for the specific role that was clicked
                // Instead of trying to find "related roles" which might be causing the issue
                const combinedStaff = [];
                const roleStaff = state.roleFullNames[role] || [];
                combinedStaff.push(...roleStaff);
                
                // Debug logging to help identify the issue
                console.log('Modal Debug Info:', {
                    clickedRole: role,
                    activity: activity,
                    eventName: eventName,
                    eventType: eventType,
                    eventTime: eventTime,
                    roleStaff: roleStaff,
                    combinedStaff: combinedStaff,
                    allRoleData: state.roleFullNames
                });
                
                // Update modal content - use activity as title
                document.getElementById('role-modal-title').textContent = activity;
                
                document.getElementById('role-modal-time').textContent = eventTime;
                
                // Names section - use staff only from the clicked role
                const namesContainer = document.getElementById('role-modal-names');
                
                if (combinedStaff.length > 0) {
                    // Check if this role is an AC role for styling
                    const isAcRole = role.startsWith('AC ');
                    const acRoleClass = isAcRole ? 'ac-role' : '';
                    
                    const nameTagsHTML = combinedStaff.map(name => {
                        return `<span class="role-modal-name-tag ${acRoleClass}">${name}</span>`;
                    }).join('');
                    namesContainer.innerHTML = nameTagsHTML;
                } else {
                    namesContainer.innerHTML = '<span class="role-modal-name-tag">No staff assigned</span>';
                }
                
                // Description section
                const descriptionSection = document.getElementById('role-modal-description-section');
                const descriptionContainer = document.getElementById('role-modal-description');
                
                if (description && description.trim()) {
                    descriptionContainer.textContent = description;
                    descriptionSection.style.display = 'block';
                } else {
                    descriptionSection.style.display = 'none';
                }
                
                // Show modal
                document.getElementById('role-modal').classList.add('active');
            }

            function setupDutiesSummaryModal() {
                const modal = document.getElementById('duties-summary-modal');
                const closeBtn = document.getElementById('duties-summary-modal-close');
                const triggerBtn = document.getElementById('duties-summary-btn');
                
                // Duties data for each AC role
                const dutiesData = {
                    'AC 1': [
                        'Music Program',
                        'Dance Prep (T)',
                        'Dance DJ (T)',
                        'Games Night',
                        'Dance Lead (F)',
                        'Wednesday Exercise Coordinator'
                    ],
                    'AC 2': [
                        'Music Program',
                        'Dance Prep (T)',
                        'Dance Lead (T)',
                        'Games Night Accom',
                        'TIHS Assist',
                        'Wednesday Exercise Coordinator',
                        'Bus Bye Bye',
                        'Friday Exercise Coordinator'
                    ],
                    'AC 3': [
                        'Music Program',
                        'Games Night',
                        'Pizza Night',
                        'Site Office',
                        'Communications Coordinator',
                        'Wednesday Exercise Coordinator'
                    ],
                    'AC 4': [
                        'Singers',
                        'Devo Assist (T)',
                        'Games Night Lead',
                        'Hall Monitor',
                        'Testimony Rooms',
                        'Dance Accom (F)',
                        'Bus Bye Bye'
                    ],
                    'AC 5': [
                        'Check-in Lead',
                        'Orientation/Hall Monitor',
                        'Breakfast Lead',
                        'Variety Show',
                        'Games Night',
                        'Pizza Night Aid'
                    ],
                    'AC 6': [
                        'Orientation/Hall Monitor',
                        'Lunch Lead',
                        'Variety Show',
                        'Games Night',
                        'Lost & Found Coordinator',
                        'Friday Exercise Coordinator'
                    ],
                    'AC 7': [
                        'Class Duty/Lead',
                        'THIS Lead',
                        'Dance Accom (F)',
                        'Site Office',
                        'Thank You-Notes Coordinator',
                        'Thursday Exercise Coordinator'
                    ],
                    'AC 8': [
                        'Dinner Lead',
                        'Games Night',
                        'Hall Monitor',
                        'TIHS - Slideshow',
                        'Social Media Coordinator',
                        'Thursday Exercise Coordinator',
                        'Tuesday Exercise Coordinator'
                    ],
                    'AC 9': [
                        'Bus Welcome',
                        'Flex-Time Lead',
                        'Dance Accom (T)',
                        'Games Night',
                        'TIHS - Assist',
                        'Tech Bag Coordinator',
                        'Tuesday Exercise Coordinator'
                    ],
                    'AC 10': [
                        'Dance',
                        'Orientation Prep',
                        'Orientation Assist',
                        'Flex-Time Lead',
                        'Dance Accom (T)',
                        'Lunch Lead Assist (Th)'
                    ]
                };
                
                // Open modal when trigger button is clicked
                triggerBtn.addEventListener('click', () => {
                    populateDutiesSummary(dutiesData);
                    modal.classList.add('active');
                });
                
                // Close modal handlers
                closeBtn.addEventListener('click', () => {
                    modal.classList.remove('active');
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.classList.contains('active')) {
                        modal.classList.remove('active');
                    }
                });
            }

            function populateDutiesSummary(dutiesData) {
                const gridContainer = document.querySelector('.duties-summary-grid');
                let gridHTML = '';
                
                // Generate columns for each AC role
                Object.entries(dutiesData).forEach(([role, duties]) => {
                    const dutiesListHTML = duties.map(duty => `<li>${duty}</li>`).join('');
                    
                    // Get the assigned name for this role from the global state
                    const assignments = globalState.roleAssignments && globalState.roleAssignments[role];
                    const assignedName = assignments && assignments.length > 0 ? ` (${assignments[0]})` : '';
                    const acRoleClass = role.startsWith('AC ') ? 'ac-role' : '';
                    
                    gridHTML += `
                        <div class="duties-summary-column">
                            <h3 class="${acRoleClass}">${role}${assignedName}</h3>
                            <ul>
                                ${dutiesListHTML}
                            </ul>
                        </div>
                    `;
                });
                
                gridContainer.innerHTML = gridHTML;
            }

            function savePreferences() {
                const filters = Array.from(document.querySelectorAll('#filter-panel input[type="checkbox"]')).map(cb => ({ value: cb.value, checked: cb.checked }));
                const isCardView = document.querySelector('.card-view.active') !== null;
                localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, JSON.stringify({ filters, isCardView }));
            }

            function loadPreferences() {
                const saved = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
                if (!saved) return { isCardView: true };
                
                const { filters, isCardView = true } = JSON.parse(saved);
                
                if (filters) {
                    filters.forEach(filter => {
                        document.querySelectorAll(`input[value="${filter.value}"]`).forEach(cb => cb.checked = filter.checked);
                        document.querySelectorAll(`[data-role="${filter.value}"]`).forEach(el => el.style.display = filter.checked ? '' : 'none');
                    });
                }
                
                updateColumnAbbreviations();
                
                return { isCardView };
            }

            function initialize() {
                preprocessData(scheduleData);
                const swiperWrapper = document.querySelector(CONFIG.SELECTORS.swiperWrapper);
                
                // Generate slides with both table and card views
                swiperWrapper.innerHTML = CONFIG.DAYS_ORDER.map(day => `
                    <div class="swiper-slide" data-day="${day}">
                        <div class="table-view">
                            ${generateCalendarForDay(day)}
                        </div>
                        ${generateCardViewForDay(day)}
                    </div>
                `).join('');
                
                populateFilters();
                const preferences = loadPreferences();
                updateColumnAbbreviations(); // Initial abbreviation update after calendar generation
                
                // Regenerate card views after filters are applied to ensure they respect saved preferences
                regenerateCardViews();
                
                const swiper = new Swiper('.swiper', {
                    navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
                    keyboard: { enabled: true },
                    on: {
                        slideChangeTransitionEnd: function () {
                            updateActiveDayButton(this);
                            updateCurrentTimeIndicator(this);
                        }
                    }
                });
                
                setupEventListeners(swiper);
                setupRoleModal(); // Move this after DOM is fully ready
                setupDutiesSummaryModal(); // Setup duties summary modal
                setupViewToggle(preferences.isCardView);
                
                const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
                const todayIndex = CONFIG.DAYS_ORDER.indexOf(today);
                if (todayIndex !== -1) {
                    swiper.slideTo(todayIndex, 0);
                }
                if (swiper.slides.length > 0) {
                     swiper.emit('slideChangeTransitionEnd');
                }
                setInterval(() => updateCurrentTimeIndicator(swiper), 60000);
            }

            function setupViewToggle(initialIsCardView = true) {
                const viewToggleBtn = document.getElementById('view-toggle-btn');
                let isCardView = initialIsCardView;
                
                const updateViews = () => {
                    viewToggleBtn.textContent = isCardView ? 'Table View' : 'Card View';
                    document.querySelectorAll('.swiper-slide').forEach(slide => {
                        const tableView = slide.querySelector('.table-view');
                        const cardView = slide.querySelector('.card-view');
                        if (isCardView) {
                            tableView.classList.remove('active');
                            cardView.classList.add('active');
                        } else {
                            tableView.classList.add('active');
                            cardView.classList.remove('active');
                        }
                    });
                    // Regenerate card views when switching to card view
                    if (isCardView) {
                        regenerateCardViews();
                    }
                };
                
                updateViews();
                
                viewToggleBtn.addEventListener('click', () => {
                    isCardView = !isCardView;
                    updateViews();
                    savePreferences();
                });
            }

            // Name search functionality
            function setupNameSearch() {
                const searchInput = document.getElementById('name-search-input');
                const searchDropdown = document.getElementById('name-search-dropdown');
                const clearButton = document.getElementById('name-search-clear');
                let selectedNameData = null;
                
                function populateSearchDropdown(searchTerm = '') {
                    const filteredNames = state.allNames.filter(nameData => 
                        nameData.searchText.includes(searchTerm.toLowerCase())
                    );
                    
                    searchDropdown.innerHTML = '';
                    
                    if (filteredNames.length === 0) {
                        searchDropdown.innerHTML = '<div class="name-search-option">No names found</div>';
                        return;
                    }
                    
                    filteredNames.forEach(nameData => {
                        const option = document.createElement('div');
                        option.className = 'name-search-option';
                        option.innerHTML = `
                            <span class="name-role">${nameData.role}</span>
                            <span class="name-full">${nameData.fullName}</span>
                        `;
                        option.addEventListener('click', () => selectName(nameData));
                        searchDropdown.appendChild(option);
                    });
                }
                
                function selectName(nameData) {
                    selectedNameData = nameData;
                    nameSearchState.isActive = true;
                    nameSearchState.selectedRole = nameData.role;
                    nameSearchState.adjacentRole = getAdjacentRole(nameData.role);
                    searchInput.value = `${nameData.role} - ${nameData.fullName}`;
                    searchDropdown.classList.remove('active');
                    clearButton.classList.add('active');
                    
                    // Filter to show only the selected person's role
                    filterToRole(nameData.role);
                }
                
                function filterToRole(selectedRole) {
                    // Hide all role columns first
                    state.roles.forEach(role => {
                        const roleClass = role.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        const cols = document.querySelectorAll(`[data-role="${roleClass}"]`);
                        cols.forEach(col => {
                            col.style.display = 'none';
                        });
                    });
                    
                    // Determine which roles to show (selected role + adjacent role + Agenda)
                    const rolesToShow = [selectedRole];
                    
                    // Find adjacent role based on pairing rules
                    const adjacentRole = getAdjacentRole(selectedRole);
                    if (adjacentRole && state.roles.includes(adjacentRole)) {
                        rolesToShow.push(adjacentRole);
                    }
                    
                    // Always include Agenda
                    rolesToShow.push('Agenda');
                    
                    // Show the selected roles
                    rolesToShow.forEach(role => {
                        const roleClass = role.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        document.querySelectorAll(`[data-role="${roleClass}"]`).forEach(col => {
                            col.style.display = '';
                        });
                    });
                    
                    // Update column abbreviations
                    updateColumnAbbreviations();
                    
                    // Regenerate card views if we're currently in card view mode
                    if (document.querySelector('.card-view.active')) {
                        regenerateCardViews();
                    }
                    
                    // Update role filter checkboxes to reflect the current state
                    updateRoleFilterCheckboxes(selectedRole, adjacentRole);
                }
                
                function clearSearch() {
                    selectedNameData = null;
                    clearNameSearch();
                    
                    // Reset all role filters to show all columns
                    resetRoleFilters();
                }
                
                function resetRoleFilters() {
                    // Show all role columns
                    state.roles.forEach(role => {
                        const roleClass = role.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        const cols = document.querySelectorAll(`[data-role="${roleClass}"]`);
                        cols.forEach(col => {
                            col.style.display = '';
                        });
                    });
                    
                    // Check all role filter checkboxes
                    document.querySelectorAll('.role-option input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = true;
                    });
                    
                    // Update column abbreviations
                    updateColumnAbbreviations();
                    
                    // Regenerate card views if we're currently in card view mode
                    if (document.querySelector('.card-view.active')) {
                        regenerateCardViews();
                    }
                }
                
                // Event listeners
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.trim();
                    
                    if (searchTerm.length > 0) {
                        populateSearchDropdown(searchTerm);
                        searchDropdown.classList.add('active');
                        clearButton.classList.add('active');
                    } else {
                        searchDropdown.classList.remove('active');
                        clearButton.classList.remove('active');
                        // Reset filters when search is cleared
                        if (nameSearchState.isActive) {
                            clearNameSearch();
                            resetRoleFilters();
                        }
                    }
                });
                
                searchInput.addEventListener('focus', () => {
                    if (searchInput.value.trim().length > 0) {
                        searchDropdown.classList.add('active');
                    }
                });
                
                searchInput.addEventListener('blur', (e) => {
                    // Delay hiding dropdown to allow for click events
                    setTimeout(() => {
                        if (!searchDropdown.contains(document.activeElement)) {
                            searchDropdown.classList.remove('active');
                        }
                    }, 200);
                });
                
                clearButton.addEventListener('click', clearSearch);
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
                        searchDropdown.classList.remove('active');
                    }
                });
                
                // Populate initial dropdown
                populateSearchDropdown();
            }

            initialize();
            setupNameSearch();
        });
    </script>
</body>
</html>